{% extends "layouts/data-selector-mvp.html" %}

{% set pageName="Home" %}

{% block beforeContent %}
{{ govukPhaseBanner({
  tag: {
    text: "Beta"
  },
  html: 'This is a new service. Help us improve it and <a class="govuk-link" href="#">give your feedback (opens in new tab)</a>.'
}) }}
<a href="create-pollutant.html" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

   
    
 
    <div class="govuk-form-group">
      <fieldset class="govuk-fieldset" aria-describedby="time-hint">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
          <h1 class="govuk-heading-l">
            Add year(s)
          </h1>
         <!--  <p class="govuk-body">Data is available in hourly, daily average or annual average format.</p> -->
           
       <div class="govuk-radios govuk-!-margin-top-0" data-module="govuk-radios">
  <!-- Year to date -->
  <div class="govuk-radios__item">
    <input class="govuk-radios__input" id="time-ytd" name="time" type="radio" value="ytd">
    <label class="govuk-label govuk-radios__label" for="time-ytd">
      Year to date (1 January to <span id="ytd-today"></span>)
    </label>
  </div>

  <!-- Any year (single year) -->
   <div class="govuk-radios__item">
  <input class="govuk-radios__input" id="time-any" name="time" type="radio" value="any" data-aria-controls="conditional-time-any">
  <label class="govuk-label govuk-radios__label" for="time-any">Any year</label>
  <div id="time-any-hint" class="govuk-hint govuk-radios__hint">Choose a single whole year</div>
</div>
<div class="govuk-radios__conditional govuk-radios__conditional--hidden" id="conditional-time-any">
  <div class="govuk-form-group" id="any-year-group">
    <label class="govuk-label" for="any-year-input">Year</label>
    <div id="any-year-hint" class="govuk-hint">For example: 2009</div>
    <input
      class="govuk-input govuk-input--width-4"
      id="any-year-input"
      name="any-year-input"
      type="text"
      inputmode="numeric"
      pattern="[0-9]*"
      maxlength="4"
      aria-describedby="any-year-hint">
  </div>
</div>

<!-- Range of years -->
<div class="govuk-radios__item">
  <input class="govuk-radios__input" id="time-range" name="time" type="radio" value="range" data-aria-controls="conditional-time-range">
  <label class="govuk-label govuk-radios__label" for="time-range">Range of years</label>
  <div id="time-range-hint" class="govuk-hint govuk-radios__hint">Choose up to 5 whole years at a time</div>
</div>
<div class="govuk-radios__conditional govuk-radios__conditional--hidden" id="conditional-time-range">
  <div class="govuk-form-group" id="range-start-group">
    <label class="govuk-label" for="range-start-year">Enter start year</label>
    <div id="range-start-hint" class="govuk-hint">For example: 2009</div>
    <div class="govuk-date-input">
      <div class="govuk-date-input__item">
        <div class="govuk-form-group">
          <input
            class="govuk-input govuk-date-input__input govuk-input--width-4"
            id="range-start-year"
            name="range-start-year"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="4"
            aria-describedby="range-start-hint">
        </div>
      </div>
    </div>
  </div>

  <div class="govuk-form-group" id="range-end-group">
    <label class="govuk-label" for="range-end-year">Enter end year</label>
    <div id="range-end-hint" class="govuk-hint">For example: 2010</div>
    <div class="govuk-date-input">
      <div class="govuk-date-input__item">
        <div class="govuk-form-group">
          <input
            class="govuk-input govuk-date-input__input govuk-input--width-4"
            id="range-end-year"
            name="range-end-year"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="4"
            aria-describedby="range-end-hint">
        </div>
      </div>
    </div>
  </div>
</div>

</div>
          
        
         
      </fieldset>
      
    </div>

    {{ govukButton({
      text: "Continue"
    }) }}
   
      </div>
    </div>
<!-- end of second row-->
 
<script>
(function () {
  const MIN_YEAR = 1973;
  const MAX_YEAR = 2025;

  function clearErrors() {
    document.querySelectorAll('.govuk-form-group--error').forEach(el => el.classList.remove('govuk-form-group--error'));
    document.querySelectorAll('.govuk-input--error').forEach(el => el.classList.remove('govuk-input--error'));
    document.querySelectorAll('.govuk-error-message').forEach(el => el.remove());
    // remove error ids from describedby
    document.querySelectorAll('[aria-describedby]').forEach(input => {
      input.setAttribute('aria-describedby',
        input.getAttribute('aria-describedby')
          .split(' ')
          .filter(id => id && !id.endsWith('-error'))
          .join(' ')
      );
    });
  }

  function showError(groupId, inputId, message) {
    const group = document.getElementById(groupId);
    const input = document.getElementById(inputId);
    if (!group || !input) return;

    group.classList.add('govuk-form-group--error');
    input.classList.add('govuk-input--error');

    const errorId = inputId + '-error';
    // Create error node with GOV.UK styling
    const p = document.createElement('p');
    p.className = 'govuk-error-message';
    p.id = errorId;
    p.innerHTML = '<span class="govuk-visually-hidden">Error:</span> ' + message;

    // Insert just before the input (after label/hint)
    const where = input.parentElement; // inner form-group
    where.insertBefore(p, input);

    // Link via aria-describedby
    const describedby = (input.getAttribute('aria-describedby') || '').trim();
    input.setAttribute('aria-describedby', (describedby ? describedby + ' ' : '') + errorId);
  }

  function isFourDigitYear(value) {
    return /^\d{4}$/.test(value);
  }

  function withinRange(year) {
    const n = Number(year);
    return n >= MIN_YEAR && n <= MAX_YEAR;
  }

  function validateAnyYear() {
    const year = (document.getElementById('any-year-input').value || '').trim();
    if (!year) {
      showError('any-year-group', 'any-year-input', 'Enter a year.');
      return null;
    }
    if (!isFourDigitYear(year)) {
      showError('any-year-group', 'any-year-input', 'Enter a 4-digit year, for example 2009.');
      return null;
    }
    if (!withinRange(year)) {
      showError('any-year-group', 'any-year-input', `Year must be between ${MIN_YEAR} and ${MAX_YEAR}.`);
      return null;
    }
    return Number(year);
  }

  function validateRangeYears() {
    const start = (document.getElementById('range-start-year').value || '').trim();
    const end   = (document.getElementById('range-end-year').value || '').trim();

    let ok = true;

    if (!start) {
      showError('range-start-group', 'range-start-year', 'Enter a start year.');
      ok = false;
    } else if (!isFourDigitYear(start)) {
      showError('range-start-group', 'range-start-year', 'Start year must be 4 digits, for example 2009.');
      ok = false;
    } else if (!withinRange(start)) {
      showError('range-start-group', 'range-start-year', `Start year must be between ${MIN_YEAR} and ${MAX_YEAR}.`);
      ok = false;
    }

    if (!end) {
      showError('range-end-group', 'range-end-year', 'Enter an end year.');
      ok = false;
    } else if (!isFourDigitYear(end)) {
      showError('range-end-group', 'range-end-year', 'End year must be 4 digits, for example 2010.');
      ok = false;
    } else if (!withinRange(end)) {
      showError('range-end-group', 'range-end-year', `End year must be between ${MIN_YEAR} and ${MAX_YEAR}.`);
      ok = false;
    }

    if (ok) {
      const s = Number(start), e = Number(end);
      if (s > e) {
        showError('range-start-group', 'range-start-year', 'Start year must be the same as or before the end year.');
        showError('range-end-group', 'range-end-year', 'End year must be the same as or after the start year.');
        ok = false;
      }
      // If you also want to enforce the “up to 5 years” rule programmatically, uncomment:
      // if ((e - s + 1) > 5) {
      //   showError('range-end-group', 'range-end-year', 'Choose a range of up to 5 years.');
      //   ok = false;
      // }
    }

    return ok ? { start: Number(start), end: Number(end) } : null;
  }

  document.querySelector('.govuk-button').addEventListener('click', function (e) {
    e.preventDefault();
    clearErrors();

    const selected = document.querySelector('input[name="time"]:checked');
    if (!selected) {
      // Keep your existing alert for missing radio choice (page-level error would require extra markup)
      alert('Please select a year option');
      return;
    }

    const today = new Date();
    const currentYear = today.getFullYear();
    const formattedToday = new Intl.DateTimeFormat('en-GB', {
      day: 'numeric', month: 'long', year: 'numeric'
    }).format(today);

    let timePeriod = 'None selected';

    if (selected.id === 'time-ytd') {
      timePeriod = `1 January to ${formattedToday}`;
    }
    else if (selected.id === 'time-any') {
      const year = validateAnyYear();
      if (year === null) return; // stop on inline error

      if (year === currentYear) {
        timePeriod = `1 January to ${formattedToday}`;
      } else {
        timePeriod = `1 January to 31 December ${year}`;
      }
    }
    else if (selected.id === 'time-range') {
      const range = validateRangeYears();
      if (range === null) return; // stop on inline error

      if (range.end === currentYear) {
        timePeriod = `1 January ${range.start} to ${formattedToday}`;
      } else {
        timePeriod = `1 January ${range.start} to 31 December ${range.end}`;
      }
    }

    // Store for summary page and redirect
    sessionStorage.setItem('selectedTimePeriod', timePeriod);
    window.location.href = 'create-pollutant.html';
  });

  // Optional: hard-block extra digits during typing (beyond maxlength)
  ['any-year-input','range-start-year','range-end-year'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => {
      el.value = el.value.replace(/\D/g, '').slice(0, 4);
    });
  });
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
  // Format like "1 August"
  const today = new Date();
  const formatted =
    new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }).format(today);

  const span = document.getElementById('ytd-today');
  if (span) span.textContent = formatted;
});
</script>



{% endblock %}
