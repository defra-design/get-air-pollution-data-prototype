{% extends "layouts/v8.html" %}

{% set pageName="Home" %}

{% block beforeContent %}
{{ govukPhaseBanner({
  tag: { text: "Beta" },
  html: 'This is a new service. Help us improve it and <a class="govuk-link" href="#">give your feedback (opens in new tab)</a>.'
}) }}
<a href="create-pollutant.html" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <h1 class="govuk-heading-l">Add data source</h1>

   <!--  <p class="govuk-body">
      <a href="#" class="govuk-link">Find out more about sources of air pollution data (opens in new tab)</a>
    </p> -->

     <details class="govuk-details">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      Find out more about each monitoring network
    </span>
  </summary>
  <div class="govuk-details__text">
   <table class="govuk-table">
 <!--  <caption class="govuk-table__caption govuk-table__caption--m">
    UK AIR monitoring networks (automatic and non-automatic)
  </caption> -->
  <thead class="govuk-table__head">
    <tr class="govuk-table__row">
      <th scope="col" class="govuk-table__header">Network</th>
      <th scope="col" class="govuk-table__header">What it measures</th>
      <th scope="col" class="govuk-table__header">Start</th>
      <th scope="col" class="govuk-table__header">End</th>
      <th scope="col" class="govuk-table__header">Instrument / method</th>
    </tr>
  </thead>
  <tbody class="govuk-table__body">

    <!-- AUTOMATIC NETWORKS -->
    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Automatic Urban and Rural Network (AURN)</th>
      <td class="govuk-table__cell">NOx, O<sub>3</sub>, SO<sub>2</sub>, CO, PM<sub>10</sub>, PM<sub>2.5</sub></td>
      <td class="govuk-table__cell">1972</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Chemiluminescence (NOx), UV photometry (O<sub>3</sub>), UV fluorescence (SO<sub>2</sub>), NDIR (CO), PM mass-equivalent (TEOM-FDMS / BAM) and daily gravimetric.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Automatic Hydrocarbon Network</th>
      <td class="govuk-table__cell">Speciated VOCs (incl. benzene, 1,3-butadiene)</td>
      <td class="govuk-table__cell">1992</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Automatic gas chromatographs (PerkinElmer GC) reporting hourly VOCs.</td>
    </tr>

   <!--  <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Automatic London Network (subset of AURN)</th>
      <td class="govuk-table__cell">NOx, O<sub>3</sub>, SO<sub>2</sub>, CO, PM<sub>10</sub>, PM<sub>2.5</sub></td>
      <td class="govuk-table__cell">1994</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">As AURN (reference/equivalent continuous analysers; PM TEOM-FDMS / BAM).</td>
    </tr> -->

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Locally-managed automatic monitoring</th>
      <td class="govuk-table__cell">Local authority & other automatic NO<sub>2</sub>, O<sub>3</sub>, PM, CO, SO<sub>2</sub></td>
      <td class="govuk-table__cell">1973</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Varies by provider; typically AURN-equivalent continuous analysers and BAM/FDMS for PM.</td>
    </tr>

    <!-- NON-AUTOMATIC NETWORKS -->
    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — Precip-Net</th>
      <td class="govuk-table__cell">Precipitation chemistry (major ions)</td>
      <td class="govuk-table__cell">1986</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Warren-Spring bulk collectors (weekly→fortnightly); Digitel DRA-12 wet-only at EMEP supersites.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — Acid Gas & Aerosol Network (AGANet)</th>
      <td class="govuk-table__cell">HNO<sub>3</sub>, HCl, NH<sub>4</sub><sup>+</sup>, NO<sub>3</sub><sup>−</sup>, SO<sub>4</sub><sup>2−</sup>, etc.</td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Monthly denuder sampling (DELTA).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — National Ammonia Monitoring Network (NAMN)</th>
      <td class="govuk-table__cell">Ammonia (NH<sub>3</sub>) / ammonium (NH<sub>4</sub><sup>+</sup>)</td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Monthly passive ALPHA (NH<sub>3</sub>); DELTA denuder (NH<sub>3</sub>/NH<sub>4</sub><sup>+</sup> at AGANet sites).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — Rural NO<sub>2</sub> Network</th>
      <td class="govuk-table__cell">NO<sub>2</sub> at rural/background</td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Palmes-type open diffusion tubes (4-weekly).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — MARGA Network</th>
      <td class="govuk-table__cell">Hourly NH<sub>3</sub>, acid gases, PM<sub>2.5</sub>/PM<sub>10</sub> inorganic ions</td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">MARGA analyser (Metrohm) – hourly ion chromatography.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UKEAP — Rural Mercury Network</th>
      <td class="govuk-table__cell">GEM, PBM (PM<sub>2.5</sub>), GOM</td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Tekran 2537x (GEM) + 1130/1135 for speciated Hg.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Black Carbon Network</th>
      <td class="govuk-table__cell">Black carbon (BC) and UVPM</td>
      <td class="govuk-table__cell">2006</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Aethalometers (Magee AE22/AE33).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">PAH Network</th>
      <td class="govuk-table__cell">Polycyclic aromatic hydrocarbons (e.g. B[a]P)</td>
      <td class="govuk-table__cell">1991</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Filter/adsorbent sampling with laboratory GC-MS (non-automatic).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">TOXics Organic Micro-Pollutants (TOMPs)</th>
      <td class="govuk-table__cell">PCBs, pesticides and other semi-volatile organics</td>
      <td class="govuk-table__cell">1991</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Hi-vol/PUF sampling with laboratory GC-MS (non-automatic).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Non-Automatic Hydrocarbon Network</th>
      <td class="govuk-table__cell">Benzene (historically also 1,3-butadiene)</td>
      <td class="govuk-table__cell">2001</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Fortnightly pumped sorbent tubes (Carbopack X) with GC-FID analysis.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Heavy Metals Network</th>
      <td class="govuk-table__cell">As, Cd, Ni, Pb in PM<sub>10</sub></td>
      <td class="govuk-table__cell">Not stated</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">PM<sub>10</sub> filter sampling with EN 14902 laboratory analysis (ICP-MS).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Particle Concentrations & Numbers (PCN)</th>
      <td class="govuk-table__cell">Particle number, size distributions, OC/EC, elemental composition</td>
      <td class="govuk-table__cell">2001</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">SMPS, CPC, EC/OC on filters, XRF, ACSM; Digitel PM<sub>2.5</sub> samplers.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">UK Urban NO<sub>2</sub> Network (UUNN)</th>
      <td class="govuk-table__cell">NO<sub>2</sub> at urban traffic locations</td>
      <td class="govuk-table__cell">2020</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Triplicate Palmes-type diffusion tubes with wind caps (co-located QA at AURN sites).</td>
    </tr>

    <!-- <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Nitrogen Dioxide Diffusion Tube (historic)</th>
      <td class="govuk-table__cell">NO<sub>2</sub> (historic national tube network)</td>
      <td class="govuk-table__cell">1993</td>
      <td class="govuk-table__cell">2005</td>
      <td class="govuk-table__cell">Diffusion tubes (Palmes), 4-weekly exposure.</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Smoke & Sulphur Dioxide (historic)</th>
      <td class="govuk-table__cell">Black smoke & SO<sub>2</sub></td>
      <td class="govuk-table__cell">1961</td>
      <td class="govuk-table__cell">2005</td>
      <td class="govuk-table__cell">Historic manual methods (smoke stain reflectometry; SO<sub>2</sub> bubbler techniques).</td>
    </tr>

    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Upland Waters Monitoring Network</th>
      <td class="govuk-table__cell">Stream/lake chemistry & biota (acidification impacts)</td>
      <td class="govuk-table__cell">1988</td>
      <td class="govuk-table__cell">Present</td>
      <td class="govuk-table__cell">Regular water chemistry sampling and biological surveys.</td>
    </tr> -->

  </tbody>
</table>

  </div>
</details>

  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds-from-desktop">

    <div class="govuk-form-group">
      <fieldset class="govuk-fieldset" aria-describedby="data-source-hint">
      <!--   <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
          Choose a data source
        </legend> -->
        <div id="data-source-hint" class="govuk-hint">
          Select one option. Some options will ask you to choose a specific network.
        </div>

     <div class="govuk-checkboxes govuk-!-margin-top-3" data-module="govuk-checkboxes">
  <!-- the three parent checkboxes live here: hourly, monthly, la -->



         <!-- Latest hourly data -->
<div class="govuk-checkboxes__item">
  <input class="govuk-checkboxes__input"
         id="ds-hourly"
         name="data-source"
         type="checkbox"
         value="hourly"
         data-aria-controls="conditional-ds-hourly">
  <label class="govuk-label govuk-checkboxes__label" for="ds-hourly">
    Latest hourly data from Defra
  </label>
</div>

<div class="govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden" id="conditional-ds-hourly">
  <fieldset class="govuk-fieldset" aria-describedby="hourly-network-hint">
    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Choose network(s)</legend>
    <div id="hourly-network-hint" class="govuk-hint">Tick one or more hourly networks.</div>

    <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes" id="hourly-networks">
      <!-- We'll populate ONLY the available networks into this container -->
      <div class="govuk-checkboxes__item" data-net-key="Automatic Urban and Rural Network (AURN)">
        <input class="govuk-checkboxes__input" id="hourly-aurn" name="hourly-network" type="checkbox"
               value="Automatic Urban and Rural Network (AURN)">
        <label class="govuk-label govuk-checkboxes__label" for="hourly-aurn">
          Automatic Urban and Rural Network (AURN)
        </label>
        <div class="govuk-hint govuk-checkboxes__hint">
          UK’s main automatic compliance network; hourly measurements of NOx, SO₂, O₃, CO, PM₁₀ and PM₂.₅.
        </div>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Automatic Hydrocarbon Network">
        <input class="govuk-checkboxes__input" id="hourly-ahn" name="hourly-network" type="checkbox"
               value="Automatic Hydrocarbon Network">
        <label class="govuk-label govuk-checkboxes__label" for="hourly-ahn">
          Automatic Hydrocarbon Network
        </label>
        <div class="govuk-hint govuk-checkboxes__hint">
          Automatic sites measuring hydrocarbons (e.g. benzene/VOCs).
        </div>
      </div>
    </div>
  </fieldset>
</div>

<!-- Monthly data -->
<div class="govuk-checkboxes__item">
  <input class="govuk-checkboxes__input"
         id="ds-monthly"
         name="data-source"
         type="checkbox"
         value="monthly"
         data-aria-controls="conditional-ds-monthly">
  <label class="govuk-label govuk-checkboxes__label" for="ds-monthly">
    Weekly and monthly data from Defra
  </label>
</div>

<div class="govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden" id="conditional-ds-monthly">
  <fieldset class="govuk-fieldset" aria-describedby="monthly-network-hint">
    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">Choose network(s)</legend>
    <div id="monthly-network-hint" class="govuk-hint">Tick one or more weekly and monthly networks.</div>

    <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes" id="monthly-networks">
      <!-- Keep all items but add data-net-key on each so we can hide non-available -->
      <div class="govuk-checkboxes__item" data-net-key="UK Urban NO2 Network">
        <input class="govuk-checkboxes__input" id="monthly-uun" name="monthly-network" type="checkbox"
               value="UK Urban NO2 Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-uun">UK Urban NO₂ Network (UUNN)</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Non-Automatic Hydrocarbon Network">
        <input class="govuk-checkboxes__input" id="monthly-nahn" name="monthly-network" type="checkbox"
               value="Non-Automatic Hydrocarbon Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-nahn">Non-Automatic Hydrocarbon Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Heavy Metals Network">
        <input class="govuk-checkboxes__input" id="monthly-hm" name="monthly-network" type="checkbox"
               value="Heavy Metals Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-hm">Heavy Metals Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="UKEAP: MARGA Network">
        <input class="govuk-checkboxes__input" id="monthly-marga" name="monthly-network" type="checkbox"
               value="UKEAP: MARGA Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-marga">UKEAP: MARGA Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="UKEAP: National Ammonia Monitoring Network (NAMN)">
        <input class="govuk-checkboxes__input" id="monthly-namn" name="monthly-network" type="checkbox"
               value="UKEAP: National Ammonia Monitoring Network (NAMN)">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-namn">UKEAP: National Ammonia Monitoring Network (NAMN)</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="UKEAP: Acid Gas & Aerosol Network (AGANet)">
        <input class="govuk-checkboxes__input" id="monthly-aganet" name="monthly-network" type="checkbox"
               value="UKEAP: Acid Gas & Aerosol Network (AGANet)">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-aganet">UKEAP: Acid Gas & Aerosol Network (AGANet)</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="UKEAP: Rural NO2 Network">
        <input class="govuk-checkboxes__input" id="monthly-rural-no2" name="monthly-network" type="checkbox"
               value="UKEAP: Rural NO2 Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-rural-no2">UKEAP: Rural NO₂ Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="UKEAP: Rural Mercury Network">
        <input class="govuk-checkboxes__input" id="monthly-mercury" name="monthly-network" type="checkbox"
               value="UKEAP: Rural Mercury Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-mercury">UKEAP: Rural Mercury Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="PAH Network">
        <input class="govuk-checkboxes__input" id="monthly-pah" name="monthly-network" type="checkbox"
               value="PAH Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-pah">PAH Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Toxic Organic Micro Pollutants (TOMPs) Network">
        <input class="govuk-checkboxes__input" id="monthly-tomps" name="monthly-network" type="checkbox"
               value="Toxic Organic Micro Pollutants (TOMPs) Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-tomps">Toxic Organic Micro Pollutants (TOMPs) Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Black Carbon Network">
        <input class="govuk-checkboxes__input" id="monthly-bc" name="monthly-network" type="checkbox"
               value="Black Carbon Network">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-bc">Black Carbon Network</label>
      </div>

      <div class="govuk-checkboxes__item" data-net-key="Particle Concentrations and Numbers Network (PCN)">
        <input class="govuk-checkboxes__input" id="monthly-pcn" name="monthly-network" type="checkbox"
               value="Particle Concentrations and Numbers Network (PCN)">
        <label class="govuk-label govuk-checkboxes__label" for="monthly-pcn">Particle Concentrations and Numbers Network (PCN)</label>
      </div>
    </div>
  </fieldset>
</div>

<!-- Local authority -->
<div class="govuk-checkboxes__item">
  <input class="govuk-checkboxes__input" id="ds-la" name="data-source" type="checkbox" value="local-authority">
  <label class="govuk-label govuk-checkboxes__label" for="ds-la">
    Non-Defra data (locally managed automatic monitoring)
  </label>
</div>


        </div>
      </fieldset>
    </div>

    <div class="govuk-button-group">
      {{ govukButton({
        text: "Continue",
        attributes: { id: "add-location-button" }
      }) }}
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Read what the first page saved
  const available = (() => {
    try { return JSON.parse(sessionStorage.getItem('availableDataSources') || '{}'); }
    catch { return {}; }
  })();

  const hourlyList   = Array.isArray(available.hourly)  ? available.hourly  : [];
  const monthlyList  = Array.isArray(available.monthly) ? available.monthly : [];
  const hasLocal     = !!available.hasLocal;

  // Parent bucket rows (the main checkboxes)
  const hourlyItem  = document.getElementById('ds-hourly')?.closest('.govuk-checkboxes__item');
  const monthlyItem = document.getElementById('ds-monthly')?.closest('.govuk-checkboxes__item');
  const laItem      = document.getElementById('ds-la')?.closest('.govuk-checkboxes__item');

  if (hourlyItem)  hourlyItem.style.display  = hourlyList.length  ? '' : 'none';
  if (monthlyItem) monthlyItem.style.display = monthlyList.length ? '' : 'none';
  if (laItem)      laItem.style.display      = hasLocal           ? '' : 'none';

  // Child network rows
  const hourlyHost  = document.getElementById('hourly-networks');
  const monthlyHost = document.getElementById('monthly-networks');

  hourlyHost?.querySelectorAll('[data-net-key]').forEach(row => {
    const key = row.getAttribute('data-net-key') || '';
    row.style.display = hourlyList.includes(key) ? '' : 'none';
  });

  monthlyHost?.querySelectorAll('[data-net-key]').forEach(row => {
    const key = row.getAttribute('data-net-key') || '';
    row.style.display = monthlyList.includes(key) ? '' : 'none';
  });

  // Optional: if a parent bucket is hidden, make sure its checkbox is unticked
  if (hourlyItem && hourlyItem.style.display === 'none')  document.getElementById('ds-hourly').checked  = false;
  if (monthlyItem && monthlyItem.style.display === 'none') document.getElementById('ds-monthly').checked = false;
  if (laItem && laItem.style.display === 'none')           document.getElementById('ds-la').checked      = false;
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const goBtn = document.getElementById('add-location-button');
  if (!goBtn) return;

  goBtn.addEventListener('click', (e) => {
    e.preventDefault();

    // Parent buckets
    const hourlyChecked  = document.getElementById('ds-hourly')?.checked;
    const monthlyChecked = document.getElementById('ds-monthly')?.checked;
    const laChecked      = document.getElementById('ds-la')?.checked;

    // Child networks (only if parent is checked)
    const getCheckedValues = (hostId, inputName) => {
      const host = document.getElementById(hostId);
      if (!host) return [];
      return Array.from(host.querySelectorAll(`input[name="${inputName}"]:checked`))
        .map(el => el.value);
    };

    const selected = {
      hourly: {
        enabled: !!hourlyChecked,
        networks: hourlyChecked ? getCheckedValues('hourly-networks', 'hourly-network') : []
      },
      monthly: {
        enabled: !!monthlyChecked,
        networks: monthlyChecked ? getCheckedValues('monthly-networks', 'monthly-network') : []
      },
      local: !!laChecked
    };

    // Persist for the create page
    sessionStorage.setItem('selectedDataSources', JSON.stringify(selected));

    // Back to summary
    window.location.href = 'create-pollutant.html';
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // If pollutants have changed since user last chose data sources, nuke the choice
  let cur = [];
  try { cur = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]'); } catch { cur = []; }
  const hash = JSON.stringify((Array.isArray(cur) ? cur : [])
                .map(s => (s || '').toLowerCase().trim())
                .sort());
  const KEY = 'dsPollutantHash';
  const prev = sessionStorage.getItem(KEY) || '';
  if (hash !== prev) {
    sessionStorage.removeItem('selectedDataSources');
    sessionStorage.setItem(KEY, hash);
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- helpers ---
  const qs  = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const setChecked = (input, checked) => {
    if (!input) return;
    input.checked = !!checked;
    // fire change to trigger govuk-frontend conditional reveals
    input.dispatchEvent(new Event('change', { bubbles: true }));
  };

  // current availability (already prepared by your earlier script)
  let available = {};
  try { available = JSON.parse(sessionStorage.getItem('availableDataSources') || '{}'); } catch {}
  const hourlyAvail  = Array.isArray(available.hourly)  ? available.hourly  : [];
  const monthlyAvail = Array.isArray(available.monthly) ? available.monthly : [];
  const hasLocal     = !!available.hasLocal;

  const elHourlyParent  = qs('#ds-hourly');
  const elMonthlyParent = qs('#ds-monthly');
  const elLocalParent   = qs('#ds-la');

  const hourlyHost  = qs('#hourly-networks');
  const monthlyHost = qs('#monthly-networks');

  const getCheckedValues = (host, name) =>
    host ? qsa(`input[name="${name}"]:checked`, host).map(el => el.value) : [];

  const persist = () => {
    const selected = {
      hourly: {
        enabled: !!(elHourlyParent && elHourlyParent.checked),
        networks: getCheckedValues(hourlyHost, 'hourly-network')
      },
      monthly: {
        enabled: !!(elMonthlyParent && elMonthlyParent.checked),
        networks: getCheckedValues(monthlyHost, 'monthly-network')
      },
      local: !!(elLocalParent && elLocalParent.checked)
    };
    sessionStorage.setItem('selectedDataSources', JSON.stringify(selected));
  };

  // restore previous selection (if any), intersecting with current availability
  let saved = null;
  try { saved = JSON.parse(sessionStorage.getItem('selectedDataSources') || 'null'); } catch {}

  if (saved) {
    // filter to currently available options
    const hourlyEnabled  = saved.hourly?.enabled && hourlyAvail.length > 0;
    const monthlyEnabled = saved.monthly?.enabled && monthlyAvail.length > 0;
    const localEnabled   = saved.local && hasLocal;

    setChecked(elHourlyParent,  hourlyEnabled);
    setChecked(elMonthlyParent, monthlyEnabled);
    setChecked(elLocalParent,   localEnabled);

    // child networks: check only those still available (and visible)
    const applyChildSelection = (host, name, allowed, chosen) => {
      if (!host) return;
      const chosenSet = new Set((chosen || []).filter(v => allowed.includes(v)));
      qsa(`input[name="${name}"]`, host).forEach(cb => {
        // respect visibility — skip hidden rows (style.display === 'none')
        const row = cb.closest('.govuk-checkboxes__item');
        const visible = row && row.style.display !== 'none';
        setChecked(cb, visible && chosenSet.has(cb.value));
      });
    };
    if (hourlyEnabled)  applyChildSelection(hourlyHost,  'hourly-network',  hourlyAvail,  saved.hourly?.networks);
    if (monthlyEnabled) applyChildSelection(monthlyHost, 'monthly-network', monthlyAvail, saved.monthly?.networks);

    // if parent is enabled but nothing remains visible, disable it
    const ensureParentHasAny = (parent, host) => {
      if (!parent || !host || !parent.checked) return;
      const anyVisibleChecked = qsa('input[type="checkbox"]:checked', host)
        .some(cb => cb.closest('.govuk-checkboxes__item')?.style.display !== 'none');
      if (!anyVisibleChecked) setChecked(parent, false);
    };
    ensureParentHasAny(elHourlyParent,  hourlyHost);
    ensureParentHasAny(elMonthlyParent, monthlyHost);

    // after restoring, persist the filtered state
    persist();
  } else {
    // FIRST LOAD: select everything that's visible & available
    setChecked(elHourlyParent,  hourlyAvail.length > 0);
    setChecked(elMonthlyParent, monthlyAvail.length > 0);
    setChecked(elLocalParent,   hasLocal);

    const checkAllVisibleChildren = (host, name) => {
      if (!host) return;
      qsa(`input[name="${name}"]`, host).forEach(cb => {
        const row = cb.closest('.govuk-checkboxes__item');
        const visible = row && row.style.display !== 'none';
        setChecked(cb, visible);
      });
    };
    if (elHourlyParent?.checked)  checkAllVisibleChildren(hourlyHost,  'hourly-network');
    if (elMonthlyParent?.checked) checkAllVisibleChildren(monthlyHost, 'monthly-network');

    persist();
  }

  // live-save as user edits
  qsa('input[type="checkbox"][name="data-source"]').forEach(cb => {
    cb.addEventListener('change', () => {
      // if a parent is unchecked, also uncheck its children
      if (cb.id === 'ds-hourly' && !cb.checked) {
        qsa('input[name="hourly-network"]', hourlyHost).forEach(child => setChecked(child, false));
      }
      if (cb.id === 'ds-monthly' && !cb.checked) {
        qsa('input[name="monthly-network"]', monthlyHost).forEach(child => setChecked(child, false));
      }
      persist();
    });
  });
  qsa('#hourly-networks input[name="hourly-network"], #monthly-networks input[name="monthly-network"]')
    .forEach(cb => cb.addEventListener('change', persist));
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function wireParentToChildren(parentId, hostSelector, childName) {
    const parent = document.getElementById(parentId);
    const host = document.querySelector(hostSelector);
    if (!parent || !host) return;

    parent.addEventListener('change', () => {
      const children = host.querySelectorAll(`input[name="${childName}"]`);
      children.forEach(cb => {
        const row = cb.closest('.govuk-checkboxes__item');
        const visible = !row || row.style.display !== 'none';

        // When checking the parent: tick all VISIBLE children.
        // When unchecking the parent: untick ALL children (visible or hidden).
        const targetChecked = parent.checked ? visible : false;

        if (cb.checked !== targetChecked) {
          cb.checked = targetChecked;
          cb.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });
  }

  wireParentToChildren('ds-hourly',  '#hourly-networks',  'hourly-network');
  wireParentToChildren('ds-monthly', '#monthly-networks', 'monthly-network');
  // No children under 'ds-la', so nothing to wire there.
});
</script>




{% endblock %}
