{% extends "layouts/v8.html" %}

{% set pageName="Home" %}

{% block beforeContent %}
{{ govukPhaseBanner({
  tag: {
    text: "Beta"
  },
  html: 'This is a new service. Help us improve it and <a class="govuk-link" href="#">give your feedback (opens in new tab)</a>.'
}) }}

<a href="../hub" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters-from-desktop">
        <h1 class="govuk-heading-l">Create a custom dataset</h1>
<p class="govuk">Choose pollutant(s)
</p>
     
    <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Pollutant
    </dt>
    <dd class="govuk-summary-list__value" id="pollutant-summary-list">
     None selected
    </dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="add-pollutant.html">Add<span class="govuk-visually-hidden"> pollutant</span></a>
    </dd>
  </div>
   
  
  
</dl>  

    <p class="govuk-body">Choose year(s) and location(s)</p>

      <dl class="govuk-summary-list">
    
   
  
  
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Year
    </dt>
    <dd class="govuk-summary-list__value" id="time-period-value">
      None selected
    </dd>
   <dd class="govuk-summary-list__actions" id="time-period-action" hidden>
  <a class="govuk-link" href="add-time.html">Add<span class="govuk-visually-hidden"> time period</span></a>
</dd>
  </div>

   <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Location
    </dt>
<dd class="govuk-summary-list__value" id="location-value">
  None selected
</dd>
<dd class="govuk-summary-list__actions" id="location-action" hidden>
  <a class="govuk-link" href="add-location.html">Add<span class="govuk-visually-hidden"> location</span></a>
</dd>


  </div>
 
  
</dl>

 <p class="govuk-body">Optional: choose data source(s) or site type(s)</p>
 <p class="govuk-body"><a target="_blank" href="https://draft-origin.publishing.service.gov.uk/guidance/sources-of-air-pollution-data?token=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI4YjQzNGFhZC1mZjg1LTRhOWMtOTMxZC0zZmNkZGJiYzEzNjYiLCJjb250ZW50X2lkIjoiNDhkYmUwMDMtYmQ3OS00YjlkLTlmNDQtMWM4NWUyMDdkYTlkIiwiaWF0IjoxNzU1NTk3MjI2LCJleHAiOjE3NTgyNzU2MjZ9.GTmfTBhc4vKdAg3YoGYahajjpDZeZVfECfPgQv-HDvc&utm_campaign=govuk_publishing&utm_medium=preview&utm_source=share" class="govuk-link">View more information about data sources (opens in new tab)</a></p>


      <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Data source
    </dt>
    <dd class="govuk-summary-list__value" id="data-source-list">
    Any
    </dd>
    <dd class="govuk-summary-list__actions" id="data-source-action" hidden>
  <a class="govuk-link" href="add-datasource.html">Change<span class="govuk-visually-hidden"> Data source</span></a>
</dd>
  </div>
    <div class="govuk-summary-list__row">
  <dt class="govuk-summary-list__key">
    Site type
  </dt>
  <dd class="govuk-summary-list__value" id="site-type-value">
    Any
  </dd>
 <dd class="govuk-summary-list__actions" id="site-type-action" hidden>
  <a class="govuk-link" href="add-site-type.html">Change<span class="govuk-visually-hidden"> site type</span></a>
</dd>
</div>
  
</dl>

<div id="station-inset-container" aria-live="polite"></div>
          </div>
      
        </div>

        {{ govukButton({
          text: "Continue",
          href: "download.html"
        }) }}
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const raw = sessionStorage.getItem('selectedPollutants');
  let pollutants = [];
  try { pollutants = raw ? JSON.parse(raw) : []; } catch { pollutants = []; }

  const container = document.getElementById('station-inset-container');
  if (!container) return;
  if (!Array.isArray(pollutants) || pollutants.length === 0) {
    container.innerHTML = '';
    return;
  }

  // ---------- your existing estimates & group detectors (unchanged) ----------
  const NETWORK_ESTIMATES = {
    AURN: { defra: 180, local:  0 },
    AutoHydrocarbon: { defra:  40, local: 0 },
    NonAutoHydrocarbon: { defra: 35, local: 0 },
    PAH: { defra: 30, local: 0 },
    HeavyMetals: { defra: 30, local: 0 },
    AGANet: { defra: 30, local: 0 },
    MARGA: { defra: 2,  local: 0 },
    NAMN: { defra: 100, local: 0 },
    PrecipNet: { defra: 30, local: 0 },
    RuralMercury: { defra: 2, local: 0 },
    LocalAuto: { defra: 0, local: 300 }
  };

  const BASE_COUNTS = {
    'nitrogen dioxide':           { defra: 170, local: 260 },
    'particulate matter (pm2.5)': { defra:  92, local: 210 },
    'particulate matter (pm10)':  { defra: 120, local: 240 },
    'ozone':                      { defra: 170, local:  30 },
    'sulphur dioxide':            { defra:  28, local:   3 },
    'carbon monoxide':            { defra:  35, local:   8 },
    'benzene':                    { defra:  40, local:   0 }
  };

  const norm = s => (s || '').trim().toLowerCase();

  const VOCS = new Set([
    'ethane','ethene','ethyne','propane','propene','iso-butane','n-butane','1-butene',
    'trans-2-butene','cis-2-butene','iso-pentane','n-pentane','1,3-butadiene','trans-2-pentene',
    '1-pentene','2-methylpentane','isoprene','n-hexane','n-heptane','iso-octane','n-octane',
    'benzene','toluene','ethylbenzene','m+p-xylene','o-xylene','1,2,3-trimethylbenzene',
    '1,2,4-trimethylbenzene','1,3,5-trimethylbenzene'
  ]);
  const PAHS = [
    'benzo(a)pyrene','benzo(a)anthracene','benzo(b)fluoranthene','benzo(j)fluoranthene','benzo(b+j)fluoranthene',
    'benzo(k)fluoranthene','indeno(1,2,3-cd)pyrene','dibenzo(ac)anthracene','dibenzo(ah)anthracene','dibenzo(ah+ac)anthracene',
    '1-methyl anthracene','1-methyl naphthalene','1-methyl phenanthrene','2-methyl anthracene','2-methyl naphthalene',
    '2-methyl phenanthrene','4.5-methylene phenanthrene','5-methyl chrysene','9-methyl anthracene'
  ].map(s => s.toLowerCase());
  const METALS_AIR = new Set([
    'arsenic','cadmium','chromium','cobalt','copper','iron','lead','manganese',
    'nickel','selenium','vanadium','zinc','aluminium','antinomy','antimony'
  ]);
  const looksLikeParticulateIon = (n) => (
    n.includes(' in pm10') || n.includes(' in pm2.5') || n.startsWith('particulate ') ||
    n.includes('nitrate') || n.includes('nitrite') || n.includes('sulphate') || n.includes('chloride') ||
    n.includes('ammonium') || n.includes('calcium') || n.includes('magnesium') ||
    n.includes('sodium') || n.includes('potassium')
  );
  const GASEOUS_ACIDS = ['gaseous hydrochloric acid','gaseous nitric acid','gaseous nitrous acid'];
  const AMMONIA_VARIANTS = [
    'gaseous ammonia','gaseous ammonia (active)','gaseous ammonia (passive)',
    'gaseous ammonia (diffusion tube)','particulate ammonium'
  ];
  const MERCURY_VARIANTS = ['reactive mercury','elemental mercury','mercury in pm2.5'];

  function getCountsForPollutant(rawName) {
    const n = norm(rawName);
    if (BASE_COUNTS[n]) return BASE_COUNTS[n];
    if (METALS_AIR.has(n)) return { defra: NETWORK_ESTIMATES.HeavyMetals.defra, local: 0 };
    if (n.endsWith('in precipitation')) return { defra: NETWORK_ESTIMATES.PrecipNet.defra, local: 0 };
    if (PAHS.includes(n)) return { defra: NETWORK_ESTIMATES.PAH.defra, local: 0 };
    if (VOCS.has(n)) return { defra: NETWORK_ESTIMATES.AutoHydrocarbon.defra, local: 0 };
    if (looksLikeParticulateIon(n)) return { defra: NETWORK_ESTIMATES.AGANet.defra, local: 0 };
    if (GASEOUS_ACIDS.includes(n)) return { defra: NETWORK_ESTIMATES.AGANet.defra, local: 0 };
    if (AMMONIA_VARIANTS.some(a => n === a || n === a.replace(/\s*\(.*\)/,''))) return { defra: NETWORK_ESTIMATES.NAMN.defra, local: 0 };
    if (MERCURY_VARIANTS.includes(n)) return { defra: NETWORK_ESTIMATES.RuralMercury.defra, local: 0 };
    return { defra: 0, local: 0 };
  }

  const OVERLAP = {
    'nitrogen dioxide|particulate matter (pm2.5)': 0.70,
    'nitrogen dioxide|particulate matter (pm10)':  0.70,
    'particulate matter (pm2.5)|particulate matter (pm10)': 0.85,
    'nitrogen dioxide|ozone': 0.50,
    'ozone|particulate matter (pm2.5)': 0.40,
    'nitrogen dioxide|sulphur dioxide': 0.40,
    'nitrogen dioxide|carbon monoxide': 0.60,
    'benzene|nitrogen dioxide': 0.50,
    'any|heavy-metals': 0.40,
    'any|pah': 0.40,
    'any|aganet': 0.50,
    'any|namn': 0.40,
    'any|precipnet': 0.30,
    'any|ruralmercury': 0.20
  };
  const DEFAULT_OVERLAP = 0.60;

  const MAX_DEFRA = 400;
  const MAX_LOCAL = 600;

  const items = pollutants.map(p => {
    const n = norm(p);
    const c = getCountsForPollutant(n);
    let tag = 'core';
    if (METALS_AIR.has(n)) tag = 'heavy-metals';
    else if (PAHS.includes(n)) tag = 'pah';
    else if (VOCS.has(n) || n === 'benzene') tag = 'hydrocarbon';
    else if (looksLikeParticulateIon(n) || GASEOUS_ACIDS.includes(n)) tag = 'aganet';
    else if (AMMONIA_VARIANTS.some(a => n === a || n === a.replace(/\s*\(.*\)/,''))) tag = 'namn';
    else if (n.endsWith('in precipitation')) tag = 'precipnet';
    else if (MERCURY_VARIANTS.includes(n)) tag = 'ruralmercury';
    return { name: n, defra: c.defra, local: c.local, tag };
  });

  const uniq = [];
  const seen = new Set();
  items.forEach(it => { if (!seen.has(it.name)) { seen.add(it.name); uniq.push(it); } });

  function estimateUnion(bucketKey) {
    const arr = uniq
      .map(x => ({ ...x, size: x[bucketKey] || 0 }))
      .filter(x => x.size > 0)
      .sort((a, b) => b.size - a.size);
    if (!arr.length) return 0;
    let union = arr[0].size;
    const base = arr[0];
    for (let i = 1; i < arr.length; i++) {
      const cur = arr[i];
      const k1 = `${base.name}|${cur.name}`;
      const k2 = `${cur.name}|${base.name}`;
      const kt = `any|${cur.tag}`;
      const rho = OVERLAP[k1] ?? OVERLAP[k2] ?? OVERLAP[kt] ?? DEFAULT_OVERLAP;
      union += cur.size * (1 - rho);
    }
    return Math.round(union);
  }

  const defraUnique = Math.min(estimateUnion('defra'), MAX_DEFRA);
  const localUnique = Math.min(estimateUnion('local'), MAX_LOCAL);
  const totalStationsNational = defraUnique + localUnique;

  // ---------- NEW: location-based scaling ----------
  // Countries: rough shares of stations
  const COUNTRY_WEIGHTS = {
    'England': 0.75,
    'Scotland': 0.15,
    'Wales': 0.06,
    'Northern Ireland': 0.04
  };

  // LA share per *pollutant group* (typical fraction of the national total per LA)
  const LA_SHARE_BY_TAG = {
    'core': 0.012,         // NO2 / PM
    'hydrocarbon': 0.006,  // VOCs
    'aganet': 0.006,       // ions/acids
    'heavy-metals': 0.004,
    'pah': 0.004,
    'namn': 0.008,         // ammonia often broader coverage
    'precipnet': 0.003,
    'ruralmercury': 0.002
  };
  const DEFAULT_LA_SHARE = 0.006;

  // Read selected location filters from sessionStorage
  const countriesRaw = sessionStorage.getItem('selectedCountries');   // ["England","Wales",...]
  const lasRaw       = sessionStorage.getItem('selectedLocations');   // ["Birmingham City Council",...]
  const singleLegacy = sessionStorage.getItem('selectedLocation');    // old flow e.g. "United Kingdom"

  let countries = [];
  try { countries = countriesRaw ? JSON.parse(countriesRaw) : []; } catch { countries = []; }
  let las = [];
  try { las = lasRaw ? JSON.parse(lasRaw) : []; } catch { las = []; }

  // Country scale = sum of selected country weights, clamped to [0,1]
  let countryScale = 0;
  if (Array.isArray(countries) && countries.length) {
    countryScale = countries.reduce((acc, c) => acc + (COUNTRY_WEIGHTS[c] || 0), 0);
    countryScale = Math.max(0, Math.min(1, countryScale));
  } else if (singleLegacy && COUNTRY_WEIGHTS[singleLegacy]) {
    countryScale = COUNTRY_WEIGHTS[singleLegacy];
  } else if (singleLegacy === 'United Kingdom') {
    countryScale = 1;
  }

  // LA scale = (#LAs * effective per-LA share), where effective share is the
  // average share for the selected pollutant tags (fallback to default).
  const tagsForSelected = uniq.map(u => u.tag);
  const effLaShare = tagsForSelected.length
    ? (tagsForSelected.reduce((s, t) => s + (LA_SHARE_BY_TAG[t] ?? DEFAULT_LA_SHARE), 0) / tagsForSelected.length)
    : DEFAULT_LA_SHARE;

  let laScale = 0;
  if (Array.isArray(las) && las.length) {
    laScale = las.length * effLaShare;
  }

  // Final locationScale:
  // - if both country & LA chosen → take the min (never exceed country share with a few LAs)
  // - if only one is chosen → use that
  // - if none → 1 (national)
  let locationScale = 1;
  const hasCountry = countryScale > 0;
  const hasLA = laScale > 0;

  if (hasCountry && hasLA) {
    locationScale = Math.min(countryScale, laScale);
  } else if (hasCountry) {
    locationScale = countryScale;
  } else if (hasLA) {
    locationScale = Math.min(laScale, 1);
  }

  // Apply scaling, clamp, and round
  const scaledTotal = Math.max(0, Math.min(totalStationsNational, Math.round(totalStationsNational * locationScale)));

  // ---------- Render single inset ----------
  container.innerHTML = scaledTotal > 0
    ? `<div class="govuk-inset-text" style="border-left: 10px solid #00703c; background-color: #d4fae2;">
         ${scaledTotal} stations available
       </div>`
    : `<div class="govuk-inset-text" style="border-left: 10px solid #f47738; background-color: #f9e2d7;">
         0 stations available
       </div>`;
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]');
  const hasPollutant = Array.isArray(pollutants) && pollutants.length > 0;

  const pollutantListEl = document.getElementById('pollutant-summary-list');
  const dataSourceEl    = document.getElementById('data-source-list');

  // Helper to hide/show action <dd> cells
  const setVisible = (el, show) => {
    if (!el) return;
    if (show) {
      el.removeAttribute('hidden');
      el.style.removeProperty('display');
      el.setAttribute('aria-hidden', 'false');
    } else {
      el.setAttribute('hidden', '');
      el.style.display = 'none';
      el.setAttribute('aria-hidden', 'true');
    }
  };

  // Flip the Pollutant action link label
  const pollutantActionLink = document.querySelector(
    '#pollutant-summary-list + .govuk-summary-list__actions a.govuk-link'
  );
  if (pollutantActionLink) {
    pollutantActionLink.innerHTML = (hasPollutant
      ? 'Change<span class="govuk-visually-hidden"> pollutant</span>'
      : 'Add<span class="govuk-visually-hidden"> pollutant</span>');
  }

  // Hide/show the other action links depending on whether a pollutant is selected
  setVisible(document.getElementById('time-period-action'), hasPollutant);
  setVisible(document.getElementById('location-action'),     hasPollutant);
  setVisible(document.getElementById('site-type-action'),    hasPollutant);
  setVisible(document.getElementById('data-source-action'),  hasPollutant);

  // Populate pollutant list + data sources (unchanged)
  if (hasPollutant && pollutantListEl && dataSourceEl) {
    pollutantListEl.innerHTML = pollutants.map(p => `<div>${p}</div>`).join('');

    const merged = [];
    const seen = new Set();
    pollutants.forEach(p => {
      buildNetworksForPollutant(p).forEach(item => {
        if (!seen.has(item)) { merged.push(item); seen.add(item); }
      });
    });

    dataSourceEl.innerHTML = merged.map(s => `<div>${s}</div>`).join('');
  } else if (dataSourceEl) {
    // Nothing selected → show "Any" and keep other actions hidden
    dataSourceEl.textContent = 'Any';
  }
});
</script>



<script>
// ---- mapping function (top-level, not nested) ----
function buildNetworksForPollutant(rawName) {
  const name = rawName.trim().toLowerCase();

  // helpers (preserve headings; avoid duplicates)
  const sections = [];
  const seen = new Set();
  const add = (label) => { if (!seen.has(label)) { sections.push(label); seen.add(label); } };
  const addHourly = (net) => { add('<strong>Latest hourly data from Defra</strong>'); add(net); };
  const addMonthly = (net) => { add('<strong>Weekly and monthly data from Defra</strong>'); add(net); };
  const addNonDefra = () => { add('<strong>Non-Defra data</strong>'); add('Locally managed automatic monitoring'); };

  // groups
  const isSO2 = name === 'sulphur dioxide' || name === 'gaseous sulphur dioxide';
  const isO3  = name === 'ozone';
  const isCO  = name === 'carbon monoxide';
  const isNO2 = name === 'nitrogen dioxide';
  const isNOxAsNO2 = name === 'nitrogen oxides as nitrogen dioxide';
  const isNO  = name === 'nitric oxide';
  const pmMass = ['particulate matter (pm10)','particulate matter (pm2.5)'].includes(name);

  const vocs = new Set([
    'ethane','ethene','ethyne','propane','propene','iso-butane','n-butane','1-butene',
    'trans-2-butene','cis-2-butene','iso-pentane','n-pentane','1,3-butadiene','trans-2-pentene',
    '1-pentene','2-methylpentane','isoprene','n-hexane','n-heptane','iso-octane','n-octane',
    'benzene','toluene','ethylbenzene','m+p-xylene','o-xylene','1,2,3-trimethylbenzene',
    '1,2,4-trimethylbenzene','1,3,5-trimethylbenzene'
  ]);

  const paHs = [
    'benzo(a)pyrene','benzo(a)anthracene','benzo(b)fluoranthene','benzo(j)fluoranthene','benzo(b+j)fluoranthene',
    'benzo(k)fluoranthene','indeno(1,2,3-cd)pyrene','dibenzo(ac)anthracene','dibenzo(ah)anthracene','dibenzo(ah+ac)anthracene',
    '1-methyl anthracene','1-methyl naphthalene','1-methyl phenanthrene','2-methyl anthracene','2-methyl naphthalene',
    '2-methyl phenanthrene','4.5-methylene phenanthrene','5-methyl chrysene','9-methyl anthracene'
  ].map(s => s.toLowerCase());

  const particulateIonKeywords = [
    'particulate ', ' in pm10', ' in pm2.5',
    'nitrate','nitrite','sulphate','chloride','ammonium',
    'calcium','magnesium','sodium','potassium'
  ];

  const gaseousAcids = ['gaseous hydrochloric acid','gaseous nitric acid','gaseous nitrous acid'];

  const metalsAir = new Set([
    'arsenic','cadmium','chromium','cobalt','copper','iron','lead','manganese',
    'nickel','selenium','vanadium','zinc','aluminium','antinomy','antimony'
  ]);

  const metalsInPrecip = /in precipitation$/i;

  const ammoniaVariants = [
    'gaseous ammonia','gaseous ammonia (active)','gaseous ammonia (passive)',
    'gaseous ammonia (diffusion tube)','particulate ammonium'
  ];

  const mercuryVariants = ['reactive mercury','elemental mercury','mercury in pm2.5'];

  // rules
  if (isSO2 || isO3 || isCO || isNO2 || isNOxAsNO2 || isNO || pmMass) {
    addHourly('Automatic Urban and Rural Network (AURN)');
     addNonDefra();
  }

  if (isNO2) {
    addMonthly('UK Urban NO2 Network');
    addMonthly('UKEAP: Rural NO2 Network');
     addNonDefra();
  }

  if (vocs.has(name)) {
    addHourly('Automatic Hydrocarbon Network');
    addMonthly('Non-Automatic Hydrocarbon Network');
  }

  if (paHs.includes(name)) {
    addMonthly('PAH Network');
  }

  const looksLikeParticulateIon =
    particulateIonKeywords.some(k => name.includes(k)) && !pmMass;

  if (looksLikeParticulateIon) {
    addMonthly('UKEAP: MARGA Network');
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

  if (gaseousAcids.includes(name)) {
    if (name.includes('nitric')) addHourly('UKEAP: MARGA Network');
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

  if (ammoniaVariants.some(a => name === a || name === a.replace(/\s*\(.*\)/,''))) {
    addMonthly('UKEAP: National Ammonia Monitoring Network (NAMN)');
  }

  if (metalsAir.has(name)) {
    addMonthly('Heavy Metals Network');
  }

  if (metalsInPrecip.test(rawName)) {
    addMonthly('UKEAP: Precipitation Chemistry Network (Precip-Net)');
  }

  if (mercuryVariants.includes(name)) {
    addMonthly('UKEAP: Rural Mercury Network');
  }

  if (isSO2) {
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

 

  return sections;
}

document.addEventListener('DOMContentLoaded', () => {
  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]');
  const pollutantListEl = document.getElementById('pollutant-summary-list');
  const dataSourceEl = document.getElementById('data-source-list');

  if (pollutants.length && pollutantListEl && dataSourceEl) {
    pollutantListEl.innerHTML = pollutants.map(p => `<div>${p}</div>`).join('');

    // NEW — change "Add" to "Change" if something is selected
    const pollutantActionCell = document.querySelector(
      '#pollutant-summary-list + .govuk-summary-list__actions a.govuk-link'
    );
    if (pollutantActionCell) {
      pollutantActionCell.innerHTML = 'Change<span class="govuk-visually-hidden"> pollutant</span>';
    }

    const merged = [];
    const seen = new Set();
    pollutants.forEach(p => {
      buildNetworksForPollutant(p).forEach(item => {
        if (!seen.has(item)) { merged.push(item); seen.add(item); }
      });
    });

    dataSourceEl.innerHTML = merged.map(s => `<div>${s}</div>`).join('');
  } else if (dataSourceEl) {
    dataSourceEl.textContent = 'Any';

    // NEW — make sure link says "Add" if none selected
    const pollutantActionCell = document.querySelector(
      '#pollutant-summary-list + .govuk-summary-list__actions a.govuk-link'
    );
    if (pollutantActionCell) {
      pollutantActionCell.innerHTML = 'Add<span class="govuk-visually-hidden"> pollutant</span>';
    }
  }
});

</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
  // Time period
  const timePeriod = sessionStorage.getItem('selectedTimePeriod');
  const timeCell = document.getElementById('time-period-value');
  const timeActionCell = document.getElementById('time-period-action');
  if (timePeriod && timeCell && timeActionCell) {
    timeCell.textContent = timePeriod;
    timeActionCell.innerHTML = '<a class="govuk-link" href="add-time.html">Change<span class="govuk-visually-hidden"> time period</span></a>';
  }

  // Site types
const siteTypes = sessionStorage.getItem('selectedSiteTypes');
const siteTypeCell = document.getElementById('site-type-value');
const siteTypeActionCell = document.getElementById('site-type-action');

if (siteTypes && siteTypeCell && siteTypeActionCell) {
  const list = JSON.parse(siteTypes);
  siteTypeCell.innerHTML = list.join('<br>');
  siteTypeActionCell.innerHTML = '<a class="govuk-link" href="add-site-type.html">Change<span class="govuk-visually-hidden"> site type</span></a>';
}


  const locationCell = document.getElementById('location-value');
  const locationActionCell = document.getElementById('location-action');

  const singleLocation = sessionStorage.getItem('selectedLocation');      // legacy
  const countries = sessionStorage.getItem('selectedCountries');          // NEW
  const laList = sessionStorage.getItem('selectedLocations');

  if (countries && locationCell && locationActionCell) {
    const list = JSON.parse(countries);
    locationCell.innerHTML = list.join('<br>');
    locationActionCell.innerHTML = '<a class="govuk-link" href="add-location.html">Change<span class="govuk-visually-hidden"> location</span></a>';
  } else if (laList && locationCell && locationActionCell) {
    const list = JSON.parse(laList);
    locationCell.innerHTML = list.join('<br>');
    locationActionCell.innerHTML = '<a class="govuk-link" href="add-location.html">Change<span class="govuk-visually-hidden"> location</span></a>';
  } else if (singleLocation && locationCell && locationActionCell) {
    locationCell.textContent = singleLocation;
    locationActionCell.innerHTML = '<a class="govuk-link" href="add-location.html">Change<span class="govuk-visually-hidden"> location</span></a>';
  }
});
</script>
<script>
// === Save available networks for the "Add data source" page ===
(function () {
  const HOUR_HDR   = '<strong>Latest hourly data from Defra</strong>';
  const MONTH_HDR  = '<strong>Weekly and monthly data from Defra</strong>';
  const NONDEF_HDR = '<strong>Non-Defra data</strong>';

  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]');
  if (!Array.isArray(pollutants) || !pollutants.length) {
    sessionStorage.removeItem('availableDataSources');
    return;
  }

  // Build the same flat list you already use
  const flat = [];
  const seen = new Set();
  pollutants.forEach(p => {
    (buildNetworksForPollutant(p) || []).forEach(x => {
      if (!seen.has(x)) { flat.push(x); seen.add(x); }
    });
  });

  // Split into buckets
  const buckets = { hourly: [], monthly: [], nonDefra: [] };
  let current = null;
  flat.forEach(item => {
    if (item === HOUR_HDR) current = 'hourly';
    else if (item === MONTH_HDR) current = 'monthly';
    else if (item === NONDEF_HDR) current = 'nonDefra';
    else if (current) buckets[current].push(item);
  });

  // Persist a minimal, clean payload for the next page
  const payload = {
    hourly: buckets.hourly,            // e.g. ["Automatic Urban and Rural Network (AURN)", ...]
    monthly: buckets.monthly,          // e.g. ["UK Urban NO2 Network", "Heavy Metals Network", ...]
    hasLocal: buckets.nonDefra.length > 0
  };
  sessionStorage.setItem('availableDataSources', JSON.stringify(payload));
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const dsListEl = document.getElementById('data-source-list');
  const pollutantListEl = document.getElementById('pollutant-summary-list');

  // read pollutants for the pollutant summary text (unchanged behaviour)
  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]');
  if (pollutants.length && pollutantListEl) {
    pollutantListEl.innerHTML = pollutants.map(p => `<div>${p}</div>`).join('');
  }

  if (!dsListEl) return;

  // headings we use in the summary
  const HOUR_HDR   = '<strong>Latest hourly data from Defra</strong>';
  const MONTH_HDR  = '<strong>Weekly and monthly data from Defra</strong>';
  const NONDEF_HDR = '<strong>Non-Defra data</strong>';

  // Build “available” from current pollutants (same logic you use elsewhere)
  const flat = [];          // headings + network lines, order preserved, de-duped
  const seen = new Set();
  pollutants.forEach(p => {
    (buildNetworksForPollutant(p) || []).forEach(x => {
      if (!seen.has(x)) { flat.push(x); seen.add(x); }
    });
  });

  const buckets = { hourly: [], monthly: [], nonDefra: [] };
  let current = null;
  flat.forEach(item => {
    if (item === HOUR_HDR) current = 'hourly';
    else if (item === MONTH_HDR) current = 'monthly';
    else if (item === NONDEF_HDR) current = 'nonDefra';
    else if (current) buckets[current].push(item);
  });

  // Save availability for add-datasource page
  sessionStorage.setItem('availableDataSources', JSON.stringify({
    hourly:  buckets.hourly,
    monthly: buckets.monthly,
    hasLocal: buckets.nonDefra.length > 0
  }));

  // Try to read the user's saved selection from add-datasource
  let selected = null;
  try { selected = JSON.parse(sessionStorage.getItem('selectedDataSources') || 'null'); } catch {}

  // Helper to render a grouped summary from a selection object
  const renderSelection = (sel) => {
    const out = [];
    if (sel.hourly?.enabled && sel.hourly.networks?.length) {
      out.push(HOUR_HDR, ...sel.hourly.networks);
    }
    if (sel.monthly?.enabled && sel.monthly.networks?.length) {
      out.push(MONTH_HDR, ...sel.monthly.networks);
    }
    if (sel.local) {
      out.push(NONDEF_HDR, 'Locally managed automatic monitoring');
    }
    return out.map(x => `<div>${x}</div>`).join('');
  };

  // If we have a selection, filter it against current availability (in case the pollutant changed)
  if (selected) {
    const filtered = {
      hourly: {
        enabled: !!selected.hourly?.enabled,
        networks: (selected.hourly?.networks || []).filter(n => buckets.hourly.includes(n))
      },
      monthly: {
        enabled: !!selected.monthly?.enabled,
        networks: (selected.monthly?.networks || []).filter(n => buckets.monthly.includes(n))
      },
      local: !!selected.local && buckets.nonDefra.length > 0
    };

    const hasAny =
      (filtered.hourly.enabled  && filtered.hourly.networks.length) ||
      (filtered.monthly.enabled && filtered.monthly.networks.length) ||
      filtered.local;

    if (hasAny) {
      dsListEl.innerHTML = renderSelection(filtered);
      return; // <- important: don’t fall through and overwrite with availability
    } else {
      // stale selection → drop it so we fall back to availability display
      sessionStorage.removeItem('selectedDataSources');
    }
  }

  // No valid selection → show the available networks (what the user can pick from)
  dsListEl.innerHTML = flat.length ? flat.map(x => `<div>${x}</div>`).join('') : 'Any';
});
</script>



{% endblock %}
