{% extends "layouts/v8.html" %}

{% set pageName="Home" %}

{% block beforeContent %}
{{ govukPhaseBanner({
  tag: {
    text: "Beta"
  },
  html: 'This is a new service. Help us improve it and <a class="govuk-link" href="#">give your feedback (opens in new tab)</a>.'
}) }}
<a href="create-pollutant.html" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters-from-desktop">

    <h2 class="govuk-heading-l">Download your data</h2>
<details class="govuk-details">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
     View and change your search details
    </span>
  </summary>
  <div class="govuk-details__text">
   <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
  <dt class="govuk-summary-list__key">
    Pollutant
  </dt>
  <dd class="govuk-summary-list__value" id="download-pollutant">
    None selected
  </dd>
  <dd class="govuk-summary-list__actions">
    <a class="govuk-link" href="add-pollutant.html">Change<span class="govuk-visually-hidden"> pollutant</span></a>
  </dd>
</div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
     Year
    </dt>
    <dd class="govuk-summary-list__value" id="download-time-period">
  
</dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="add-time.html">Change<span class="govuk-visually-hidden"> Year</span></a>
    </dd>
  </div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Location
    </dt>
    <dd class="govuk-summary-list__value" id="download-location">

</dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="add-location.html">Change<span class="govuk-visually-hidden"> location</span></a>
    </dd>
  </div>
  <div class="govuk-summary-list__row">
  <dt class="govuk-summary-list__key">
    Data source
  </dt>
  <dd class="govuk-summary-list__value" id="download-data-source">
    Any
  </dd>
  <dd class="govuk-summary-list__actions">
    <a class="govuk-link" href="#">Change<span class="govuk-visually-hidden"> data source</span></a>
  </dd>
</div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Site type
    </dt>
  <dd class="govuk-summary-list__value" id="download-site-type">
  <p class="govuk-body">Any</p>
</dd>
    <dd class="govuk-summary-list__actions">
        <li class="govuk-summary-list__actions-list-item">
          <a class="govuk-link" href="add-site-type.html">Change<span class="govuk-visually-hidden"> site type</span></a>
        </li>
    </dd>
  </div>
</dl>
  </div>
</details>
 
    

<h2 class="govuk-heading-m">View monitoring stations</h2>
<p class="govuk-body">View information about individual monitoring stations including: data capture, graphs and air pollution summaries.</p>

<p class="govuk-body"><a href="#" class="govuk-link">View monitoring stations that match your search</a></p>
  </div>
</div>



<div class="govuk-grid-row govuk-!-margin-top-3">
  <div class="govuk-grid-column-full">
    <div class="govuk-tabs" data-module="govuk-tabs">

  <h2 class="govuk-tabs__title">
    Contents
  </h2>
  <ul class="govuk-tabs__list">
    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
      <a class="govuk-tabs__tab" href="#past-day">
        Latest hourly data from Defra
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" href="#past-week">
        Weekly and monthly data from Defra
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" href="#past-month">
        Local authority data
      </a>
    </li>
   
  </ul>
  <div class="govuk-tabs__panel" id="past-day">
    <h2 class="govuk-heading-l">Past day</h2>
    
  </div>
  <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="past-month">
    <h2 class="govuk-heading-l">Past month</h2>
   
  </div>
</div>
  <div class="govuk-grid-column-full" id="download-content-container">
 
   
      
    <div class="govuk-inset-text govuk-!-margin-top-0">
  <h3 class="govuk-heading-s">Save your search</h3>
<p class="govuk-body">Save this URL to download data with the same details next time.</p>

<p class="govuk-body"><a href="station-list.html" class="govuk-link">https://get-air-pollution-data.defra.gov.uk/data-selector/download-data?saved=url</a></p>

</div>
</div>
      
    </div>
<!-- end of second row-->
 
<script>
document.addEventListener('DOMContentLoaded', function () {
  // === Time period ===
  const time = sessionStorage.getItem('selectedTimePeriod');
  const timeTarget = document.getElementById('download-time-period');
  if (time && timeTarget) {
    timeTarget.innerHTML = time.replace(/\n/g, '<br>');
  }

  // === Location (Countries, Local Authorities, legacy single) ===
  const locationTarget = document.getElementById('download-location');

  // Read storage
  const countriesRaw = sessionStorage.getItem('selectedCountries');   // ["England","Wales",...]
  const lasRaw       = sessionStorage.getItem('selectedLocations');   // ["Birmingham City Council",...]
  const single       = sessionStorage.getItem('selectedLocation');    // legacy e.g. "United Kingdom"

  // Parse safely
  const countries = (() => { try { return countriesRaw ? JSON.parse(countriesRaw) : null; } catch { return null; } })();
  const las       = (() => { try { return lasRaw ? JSON.parse(lasRaw) : null; } catch { return null; } })();

  if (locationTarget) {
    const parts = [];

    if (Array.isArray(countries) && countries.length) {
      parts.push(countries.join('<br>'));
    }
    if (Array.isArray(las) && las.length) {
      parts.push(las.join('<br>'));
    }
    if (!parts.length && single) {
      parts.push(single); // fallback for older flows
    }

    locationTarget.innerHTML = parts.length ? parts.join('<br>') : 'None selected';
  }

  // === Site type ===
  const siteTypes = sessionStorage.getItem('selectedSiteTypes');
  const siteTypeTarget = document.getElementById('download-site-type');
  if (siteTypes && siteTypeTarget) {
    const list = (() => { try { return JSON.parse(siteTypes); } catch { return []; } })();
    siteTypeTarget.innerHTML = Array.isArray(list) && list.length ? list.join('<br>') : 'Any';
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const target = document.getElementById('download-pollutant');
  if (!target) return;

  const raw = sessionStorage.getItem('selectedPollutants');
  let list = [];
  try { list = raw ? JSON.parse(raw) : []; } catch { list = []; }

  target.innerHTML = Array.isArray(list) && list.length
    ? list.map(p => `<div>${p}</div>`).join('')
    : 'None selected';
});
</script>

<script>
// ===== 1) YOUR UPDATED MAPPING FUNCTION (unchanged) =====
function buildNetworksForPollutant(rawName) {
  const name = rawName.trim().toLowerCase();

  // helpers (preserve headings; avoid duplicates)
  const sections = [];
  const seen = new Set();
  const add = (label) => { if (!seen.has(label)) { sections.push(label); seen.add(label); } };
  const addHourly = (net) => { add('<strong>Latest hourly data from Defra</strong>'); add(net); };
  const addMonthly = (net) => { add('<strong>Weekly and monthly data from Defra</strong>'); add(net); };
  const addNonDefra = () => { add('<strong>Non-Defra data</strong>'); add('Locally managed automatic monitoring'); };

  // groups
  const isSO2 = name === 'sulphur dioxide' || name === 'gaseous sulphur dioxide';
  const isO3  = name === 'ozone';
  const isCO  = name === 'carbon monoxide';
  const isNO2 = name === 'nitrogen dioxide';
  const isNOxAsNO2 = name === 'nitrogen oxides as nitrogen dioxide';
  const isNO  = name === 'nitric oxide';
  const pmMass = ['particulate matter (pm10)','particulate matter (pm2.5)'].includes(name);

  const vocs = new Set([
    'ethane','ethene','ethyne','propane','propene','iso-butane','n-butane','1-butene',
    'trans-2-butene','cis-2-butene','iso-pentane','n-pentane','1,3-butadiene','trans-2-pentene',
    '1-pentene','2-methylpentane','isoprene','n-hexane','n-heptane','iso-octane','n-octane',
    'benzene','toluene','ethylbenzene','m+p-xylene','o-xylene','1,2,3-trimethylbenzene',
    '1,2,4-trimethylbenzene','1,3,5-trimethylbenzene'
  ]);

  const paHs = [
    'benzo(a)pyrene','benzo(a)anthracene','benzo(b)fluoranthene','benzo(j)fluoranthene','benzo(b+j)fluoranthene',
    'benzo(k)fluoranthene','indeno(1,2,3-cd)pyrene','dibenzo(ac)anthracene','dibenzo(ah)anthracene','dibenzo(ah+ac)anthracene',
    '1-methyl anthracene','1-methyl naphthalene','1-methyl phenanthrene','2-methyl anthracene','2-methyl naphthalene',
    '2-methyl phenanthrene','4.5-methylene phenanthrene','5-methyl chrysene','9-methyl anthracene'
  ].map(s => s.toLowerCase());

  const particulateIonKeywords = [
    'particulate ', ' in pm10', ' in pm2.5',
    'nitrate','nitrite','sulphate','chloride','ammonium',
    'calcium','magnesium','sodium','potassium'
  ];

  const gaseousAcids = ['gaseous hydrochloric acid','gaseous nitric acid','gaseous nitrous acid'];

  const metalsAir = new Set([
    'arsenic','cadmium','chromium','cobalt','copper','iron','lead','manganese',
    'nickel','selenium','vanadium','zinc','aluminium','antinomy','antimony'
  ]);

  const metalsInPrecip = /in precipitation$/i;

  const ammoniaVariants = [
    'gaseous ammonia','gaseous ammonia (active)','gaseous ammonia (passive)',
    'gaseous ammonia (diffusion tube)','particulate ammonium'
  ];

  const mercuryVariants = ['reactive mercury','elemental mercury','mercury in pm2.5'];

  // rules
  if (isSO2 || isO3 || isCO || isNO2 || isNOxAsNO2 || isNO || pmMass) {
    addHourly('Automatic Urban and Rural Network (AURN)');
    addNonDefra();
  }

  if (isNO2) {
    addMonthly('UK Urban NO2 Network');
    addMonthly('UKEAP: Rural NO2 Network');
    addNonDefra();
  }

  if (vocs.has(name)) {
    addHourly('Automatic Hydrocarbon Network');
    addMonthly('Non-Automatic Hydrocarbon Network');
  }

  if (paHs.includes(name)) {
    addMonthly('PAH Network');
  }

  const looksLikeParticulateIon =
    particulateIonKeywords.some(k => name.includes(k)) && !pmMass;

  if (looksLikeParticulateIon) {
    addMonthly('UKEAP: MARGA Network');
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

  if (gaseousAcids.includes(name)) {
    if (name.includes('nitric')) addHourly('UKEAP: MARGA Network');
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

  if (ammoniaVariants.some(a => name === a || name === a.replace(/\s*\(.*\)/,''))) {
    addMonthly('UKEAP: National Ammonia Monitoring Network (NAMN)');
  }

  if (metalsAir.has(name)) {
    addMonthly('Heavy Metals Network');
  }

  if (metalsInPrecip.test(rawName)) {
    addMonthly('UKEAP: Precipitation Chemistry Network (Precip-Net)');
  }

  if (mercuryVariants.includes(name)) {
    addMonthly('UKEAP: Rural Mercury Network');
  }

  if (isSO2) {
    addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)');
  }

  return sections;
}

// ===== 2) COLLATE INTO BUCKETS BASED ON YOUR HEADINGS =====
function collateNetworks(pollutants) {
  // merge all sections from all pollutants (headings + networks, deduping, order preserved)
  const flat = [];
  const seenFlat = new Set();
  pollutants.forEach(p => {
    buildNetworksForPollutant(p).forEach(x => {
      if (!seenFlat.has(x)) { flat.push(x); seenFlat.add(x); }
    });
  });

  // split into buckets keyed by the last seen heading
  const buckets = { hourly: [], monthly: [], nonDefra: [] };
  let current = null;
  flat.forEach(item => {
    if (item.includes('<strong>Latest hourly data from Defra</strong>')) current = 'hourly';
    else if (item.includes('<strong>Weekly and monthly data from Defra</strong>')) current = 'monthly';
    else if (item.includes('<strong>Non-Defra data</strong>')) current = 'nonDefra';
    else if (current) buckets[current].push(item);
  });

  return { flat, buckets };
}

// ===== 3) RENDER SUMMARY + BUILD TABS FROM THOSE BUCKETS =====
document.addEventListener('DOMContentLoaded', function () {
  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]');

  // 3a. Render the “Data source” summary list exactly from your mapping output
  const dsTarget = document.getElementById('download-data-source');
  if (dsTarget) {
    if (!pollutants.length) {
      dsTarget.textContent = 'Any';
    } else {
      const { flat } = collateNetworks(pollutants);
      dsTarget.innerHTML = flat.map(x => `<div>${x}</div>`).join('');
    }
  }

  // 3b. Tabs: show only the sources that actually exist according to your grouping
  const tabsContainer = document.querySelector('.govuk-tabs__list');
  const panelsRoot = document.querySelector('.govuk-tabs');
  if (!tabsContainer || !panelsRoot) return;

  const { buckets } = collateNetworks(pollutants);

  // Which tabs to show (match your headings -> tab labels)
  const sources = [];
  if (buckets.hourly.length)   sources.push('Latest hourly data from Defra');
  if (buckets.monthly.length)  sources.push('Weekly and monthly data from Defra');
  if (buckets.nonDefra.length) sources.push('Non-Defra data'); // label for your Non-Defra bucket

  if (!sources.length) sources.push('Weekly and monthly data from Defra'); // fallback

  // Clear any static tabs/panels that were in the HTML
  tabsContainer.innerHTML = '';
  panelsRoot.querySelectorAll('.govuk-tabs__panel').forEach(el => el.remove());

  // Helpers
  const slugify = t => t.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
  const timePeriod = sessionStorage.getItem('selectedTimePeriod') || '';

  function buildButtons(timeText, sourceName) {
  const isMonthly = sourceName === 'Weekly and monthly data from Defra';

  if (isMonthly) {
    return `
      <h2 class="govuk-heading-m">${sourceName}</h2>
      <p class="govuk-body">Download data for ${timeText}</p>

      <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
        <span class="aq-button-secondary__icon">
          <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
            <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
          </svg>
        </span>
        <span class="aq-button-secondary__text">Download metadata</span>
      </a><br>

      <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
        <span class="aq-button-secondary__icon">
          <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
            <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
          </svg>
        </span>
        <span class="aq-button-secondary__text">Download data</span>
      </a>
    `;
  }

  // Default layout for other sources
  return `
    <h2 class="govuk-heading-m">${sourceName}</h2>
    <p class="govuk-body">Download data for ${timeText}</p>

    <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
      <span class="aq-button-secondary__icon">
        <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
          <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
        </svg>
      </span>
      <span class="aq-button-secondary__text">Download metadata</span>
    </a><br>

    <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
      <span class="aq-button-secondary__icon">
        <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
          <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
        </svg>
      </span>
      <span class="aq-button-secondary__text">Download hourly data</span>
    </a><br>

    <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
      <span class="aq-button-secondary__icon">
        <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
          <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
        </svg>
      </span>
      <span class="aq-button-secondary__text">Download daily average data</span>
    </a><br>

    <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
      <span class="aq-button-secondary__icon">
        <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
          <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
        </svg>
      </span>
      <span class="aq-button-secondary__text">Download annual average data</span>
    </a>
  `;
}


function buildYearTable(startYear, endYear, sourceName) {
  const isMonthly = sourceName === 'Weekly and monthly data from Defra';
  const hasMultipleYears = startYear !== endYear;

  let metadataButton = '';
  if (hasMultipleYears) {
    metadataButton = `
      <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
        <span class="aq-button-secondary__icon">
          <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
            <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12"
              fill="none" stroke="currentColor" stroke-width="2"></path>
          </svg>
        </span>
        <span class="aq-button-secondary__text">Download metadata</span>
      </a>
    `;
  }

  let rows = '';
  for (let year = endYear; year >= startYear; year--) {
    if (isMonthly) {
      rows += `
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">${year}</th>
          <td class="govuk-table__cell"><a href="#" class="govuk-link">Download data</a></td>
        </tr>`;
    } else {
      rows += `
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">${year}</th>
          <td class="govuk-table__cell"><a href="#" class="govuk-link">Download hourly data</a></td>
          <td class="govuk-table__cell"><a href="#" class="govuk-link">Download daily average data</a></td>
          <td class="govuk-table__cell"><a href="#" class="govuk-link">Download annual average data</a></td>
        </tr>`;
    }
  }

  const tableHead = isMonthly
    ? `
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Year</th>
          <th scope="col" class="govuk-table__header">Download</th>
        </tr>
      </thead>`
    : `
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Year</th>
          <th scope="col" class="govuk-table__header">Hourly data</th>
          <th scope="col" class="govuk-table__header">Daily average</th>
          <th scope="col" class="govuk-table__header">Annual average</th>
        </tr>
      </thead>`;

  return `
    <h2 class="govuk-heading-m">Download ${sourceName.toLowerCase()} by year</h2>
    ${metadataButton}
    <table class="govuk-table">
      ${tableHead}
      <tbody class="govuk-table__body">${rows}</tbody>
    </table>
  `;
}




  // Build a panel for each available source
  sources.forEach((source, i) => {
    const id = slugify(source);
    const isSelected = i === 0 ? ' govuk-tabs__list-item--selected' : '';
    const hiddenClass = i === 0 ? '' : ' govuk-tabs__panel--hidden';

    // Determine which bucket this tab corresponds to (for future per-bucket content if needed)
    // (Right now we only vary the heading; downloads remain placeholders)
    let dynamicContent = '';
    const rangeMatch = timePeriod.match(/(\d{4}).*to.*(\d{4})/);
    const lastYearMatch = timePeriod.match(/1 January to 31 December (\d{4})/);
    const yearToDateMatch = timePeriod.match(/1 January to \d{1,2} \w+ \d{4}/);

    if (rangeMatch) {
      const startYear = Math.max(1994, Math.min(2025, parseInt(rangeMatch[1])));
      const endYear = Math.max(1994, Math.min(2025, parseInt(rangeMatch[2])));
      dynamicContent = startYear > endYear
        ? `<p class="govuk-body">Invalid year range selected. <a href="add-time.html" class="govuk-link">Go back</a>.</p>`
        : buildYearTable(startYear, endYear, source);
    } else if (lastYearMatch || yearToDateMatch) {
      dynamicContent = buildButtons(timePeriod, source);
    } else {
      dynamicContent = `<p class="govuk-body">No valid time period selected. <a href="add-time.html" class="govuk-link">Choose one</a>.</p>`;
    }

    // Tab header
    tabsContainer.insertAdjacentHTML('beforeend', `
      <li class="govuk-tabs__list-item${ isSelected }">
        <a class="govuk-tabs__tab" href="#${id}">${source}</a>
      </li>
    `);

    // Tab content
    panelsRoot.insertAdjacentHTML('beforeend', `
      <div class="govuk-tabs__panel${ hiddenClass }" id="${id}">
        ${dynamicContent}
      </div>
    `);
  });
});
</script>







{% endblock %}
