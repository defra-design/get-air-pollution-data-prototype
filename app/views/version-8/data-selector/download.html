{% extends "layouts/v8.html" %}

{% set pageName="Home" %}

{% block beforeContent %}
{{ govukPhaseBanner({
  tag: {
    text: "Beta"
  },
  html: 'This is a new service. Help us improve it and <a class="govuk-link" href="#">give your feedback (opens in new tab)</a>.'
}) }}
<a href="create-pollutant.html" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters-from-desktop">

    <h2 class="govuk-heading-l">Download your data</h2>
<details class="govuk-details">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
     View and change your search details
    </span>
  </summary>
  <div class="govuk-details__text">
   <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
  <dt class="govuk-summary-list__key">
    Pollutant
  </dt>
  <dd class="govuk-summary-list__value" id="download-pollutant">
    None selected
  </dd>
  <dd class="govuk-summary-list__actions">
    <a class="govuk-link" href="add-pollutant.html">Change<span class="govuk-visually-hidden"> pollutant</span></a>
  </dd>
</div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
     Year
    </dt>
    <dd class="govuk-summary-list__value" id="download-time-period">
  
</dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="add-time.html">Change<span class="govuk-visually-hidden"> Year</span></a>
    </dd>
  </div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Location
    </dt>
    <dd class="govuk-summary-list__value" id="download-location">

</dd>
    <dd class="govuk-summary-list__actions">
      <a class="govuk-link" href="add-location.html">Change<span class="govuk-visually-hidden"> location</span></a>
    </dd>
  </div>
  <div class="govuk-summary-list__row">
  <dt class="govuk-summary-list__key">
    Data source
  </dt>
  <dd class="govuk-summary-list__value" id="download-data-source">
    Any
  </dd>
  <dd class="govuk-summary-list__actions">
    <a class="govuk-link" href="add-datasource.html">Change<span class="govuk-visually-hidden"> data source</span></a>
  </dd>
</div>
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      Site type
    </dt>
  <dd class="govuk-summary-list__value" id="download-site-type">
  <p class="govuk-body">Any</p>
</dd>
    <dd class="govuk-summary-list__actions">
        <li class="govuk-summary-list__actions-list-item">
          <a class="govuk-link" href="add-site-type.html">Change<span class="govuk-visually-hidden"> site type</span></a>
        </li>
    </dd>
  </div>
</dl>
  </div>
</details>
 
    

<!-- <h2 class="govuk-heading-m">View monitoring stations</h2>
<p class="govuk-body">View information about individual monitoring stations including: data capture, graphs and air pollution summaries.</p>

<p class="govuk-body"><a href="#" class="govuk-link">View monitoring stations that match your search</a></p> -->
  </div>
</div>



<div class="govuk-grid-row govuk-!-margin-top-3">
  <div class="govuk-grid-column-full">
    <div class="govuk-tabs" data-module="govuk-tabs">

  <h2 class="govuk-tabs__title">
    Contents
  </h2>
  <ul class="govuk-tabs__list">
    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
      <a class="govuk-tabs__tab" href="#past-day">
        Latest hourly data from Defra
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" href="#past-week">
        Weekly and monthly data from Defra
      </a>
    </li>
    <li class="govuk-tabs__list-item">
      <a class="govuk-tabs__tab" href="#past-month">
        Local authority data
      </a>
    </li>
   
  </ul>
  <div class="govuk-tabs__panel" id="past-day">
    <h2 class="govuk-heading-l">Past day</h2>
    
  </div>
  <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="past-month">
    <h2 class="govuk-heading-l">Past month</h2>
   
  </div>
</div>
  <div class="govuk-grid-column-full" id="download-content-container">
 
   
      
    <div class="govuk-inset-text govuk-!-margin-top-0">
  <h3 class="govuk-heading-s">Save your search</h3>
<p class="govuk-body">Save this URL to download data with the same details next time.</p>

<p class="govuk-body"><a href="station-list.html" class="govuk-link">https://get-air-pollution-data.defra.gov.uk/data-selector/download-data?saved=url</a></p>

</div>
</div>
      
    </div>
<!-- end of second row-->
<script>
/* -------------------- Shared summary initialisers -------------------- */
document.addEventListener('DOMContentLoaded', function () {
  // === Time period ===
  const time = sessionStorage.getItem('selectedTimePeriod');
  const timeTarget = document.getElementById('download-time-period');
  if (time && timeTarget) timeTarget.innerHTML = time.replace(/\n/g, '<br>');

  // === Location ===
  const locationTarget = document.getElementById('download-location');
  const countriesRaw = sessionStorage.getItem('selectedCountries');
  const lasRaw       = sessionStorage.getItem('selectedLocations');
  const single       = sessionStorage.getItem('selectedLocation'); // legacy
  let countries = [], las = [];
  try { countries = countriesRaw ? JSON.parse(countriesRaw) : []; } catch {}
  try { las = lasRaw ? JSON.parse(lasRaw) : []; } catch {}
  if (locationTarget) {
    const parts = [];
    if (countries.length) parts.push(countries.join('<br>'));
    if (las.length)       parts.push(las.join('<br>'));
    if (!parts.length && single) parts.push(single);
    locationTarget.innerHTML = parts.length ? parts.join('<br>') : 'None selected';
  }

  // === Site type ===
  const siteTypes = sessionStorage.getItem('selectedSiteTypes');
  const siteTypeTarget = document.getElementById('download-site-type');
  if (siteTypes && siteTypeTarget) {
    let list = [];
    try { list = JSON.parse(siteTypes); } catch {}
    siteTypeTarget.innerHTML = list.length ? list.join('<br>') : 'Any';
  }
});

// === Pollutants (normalise + show) ===
document.addEventListener('DOMContentLoaded', () => {
  const target = document.getElementById('download-pollutant');
  if (!target) return;

  let raw = sessionStorage.getItem('selectedPollutants');
  let arr = [];
  try { arr = raw ? JSON.parse(raw) : []; } catch {}

  const getName = (x) => typeof x === 'string'
    ? x
    : (x && typeof x === 'object' ? (x.name || x.label || x.text || x.title || x.pollutant || x.value || '') : '');

  const normalise = (s) => {
    const t = String(s).trim(); const lower = t.toLowerCase();
    const map = {
      'pm10':'Particulate matter (PM10)','pm 10':'Particulate matter (PM10)',
      'pm2.5':'Particulate matter (PM2.5)','pm 2.5':'Particulate matter (PM2.5)',
      'no2':'Nitrogen dioxide','nox as no2':'Nitrogen oxides as nitrogen dioxide',
      'so2':'Sulphur dioxide','o3':'Ozone','co':'Carbon monoxide',
      'nitric oxide (no)':'Nitric oxide'
    };
    return map[lower] || t;
  };

  const list = arr.map(getName).map(normalise).filter(Boolean);
  target.innerHTML = list.length ? list.map(p => `<div>${p}</div>`).join('') : 'None selected';
  sessionStorage.setItem('selectedPollutants_normalised', JSON.stringify(list));
});

/* -------------------- Mapping + UI builders -------------------- */
function buildNetworksForPollutant(rawName) {
  const name = rawName.trim().toLowerCase();
  const sections = [], seen = new Set();
  const add = (label) => { if (!seen.has(label)) { sections.push(label); seen.add(label); } };
  const addHourly  = (net) => { add('<strong>Latest hourly data from Defra</strong>'); add(net); };
  const addMonthly = (net) => { add('<strong>Weekly and monthly data from Defra</strong>'); add(net); };
  const addNonDefra = () => { add('<strong>Non-Defra data</strong>'); add('Locally managed automatic monitoring'); };

  const isSO2 = name === 'sulphur dioxide' || name === 'gaseous sulphur dioxide';
  const isO3  = name === 'ozone';
  const isCO  = name === 'carbon monoxide';
  const isNO2 = name === 'nitrogen dioxide';
  const isNOxAsNO2 = name === 'nitrogen oxides as nitrogen dioxide';
  const isNO  = name === 'nitric oxide';
  const pmMass = ['particulate matter (pm10)','particulate matter (pm2.5)'].includes(name);

  const vocs = new Set([
    'ethane','ethene','ethyne','propane','propene','iso-butane','n-butane','1-butene',
    'trans-2-butene','cis-2-butene','iso-pentane','n-pentane','1,3-butadiene','trans-2-pentene',
    '1-pentene','2-methylpentane','isoprene','n-hexane','n-heptane','iso-octane','n-octane',
    'benzene','toluene','ethylbenzene','m+p-xylene','o-xylene','1,2,3-trimethylbenzene',
    '1,2,4-trimethylbenzene','1,3,5-trimethylbenzene'
  ]);

  const paHs = [
    'benzo(a)pyrene','benzo(a)anthracene','benzo(b)fluoranthene','benzo(j)fluoranthene','benzo(b+j)fluoranthene',
    'benzo(k)fluoranthene','indeno(1,2,3-cd)pyrene','dibenzo(ac)anthracene','dibenzo(ah)anthracene','dibenzo(ah+ac)anthracene',
    '1-methyl anthracene','1-methyl naphthalene','1-methyl phenanthrene','2-methyl anthracene','2-methyl naphthalene',
    '2-methyl phenanthrene','4.5-methylene phenanthrene','5-methyl chrysene','9-methyl anthracene'
  ].map(s => s.toLowerCase());

  const particulateIonKeywords = ['particulate ', ' in pm10', ' in pm2.5','nitrate','nitrite','sulphate','chloride','ammonium','calcium','magnesium','sodium','potassium'];
  const gaseousAcids = ['gaseous hydrochloric acid','gaseous nitric acid','gaseous nitrous acid'];
  const metalsAir = new Set(['arsenic','cadmium','chromium','cobalt','copper','iron','lead','manganese','nickel','selenium','vanadium','zinc','aluminium','antinomy','antimony']);
  const metalsInPrecip = /in precipitation$/i;
  const ammoniaVariants = ['gaseous ammonia','gaseous ammonia (active)','gaseous ammonia (passive)','gaseous ammonia (diffusion tube)','particulate ammonium'];
  const mercuryVariants = ['reactive mercury','elemental mercury','mercury in pm2.5'];

  if (isSO2 || isO3 || isCO || isNO2 || isNOxAsNO2 || isNO || pmMass) { addHourly('Automatic Urban and Rural Network (AURN)'); addNonDefra(); }
  if (isNO2) { addMonthly('UK Urban NO2 Network'); addMonthly('UKEAP: Rural NO2 Network'); addNonDefra(); }
  if (vocs.has(name)) { addHourly('Automatic Hydrocarbon Network'); addMonthly('Non-Automatic Hydrocarbon Network'); }
  if (paHs.includes(name)) { addMonthly('PAH Network'); }
  if (particulateIonKeywords.some(k => name.includes(k)) && !pmMass) { addMonthly('UKEAP: MARGA Network'); addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)'); }
  if (gaseousAcids.includes(name)) { if (name.includes('nitric')) addHourly('UKEAP: MARGA Network'); addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)'); }
  if (ammoniaVariants.some(a => name === a || name === a.replace(/\s*\(.*\)/,''))) { addMonthly('UKEAP: National Ammonia Monitoring Network (NAMN)'); }
  if (metalsAir.has(name)) { addMonthly('Heavy Metals Network'); }
  if (metalsInPrecip.test(rawName)) { addMonthly('UKEAP: Precipitation Chemistry Network (Precip-Net)'); }
  if (mercuryVariants.includes(name)) { addMonthly('UKEAP: Rural Mercury Network'); }
  if (isSO2) { addMonthly('UKEAP: Acid Gas & Aerosol Network (AGANet)'); }
  return sections;
}

/* --- Button HTML (original styling) --- */
function buttonHtml(label) {
  return `
    <a href="#" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3">
      <span class="aq-button-secondary__icon">
        <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
          <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
        </svg>
      </span>
      <span class="aq-button-secondary__text">${label}</span>
    </a>`;
}

/* -------------------- Network descriptions -------------------- */
const NETWORK_DESCRIPTIONS = {
  'Automatic Urban and Rural Network (AURN)': 'UK-wide automatic monitoring of core pollutants at urban and rural sites.',
  'Automatic Hydrocarbon Network': 'Automatic VOC measurements at selected urban and roadside locations.',
  'Non-Automatic Hydrocarbon Network': 'Weekly canister sampling of hydrocarbons with laboratory analysis.',
  'UK Urban NO2 Network': 'Diffusion tube network providing monthly nitrogen dioxide concentrations at urban sites.',
  'UKEAP: Rural NO2 Network': 'Monthly diffusion tube measurements of NO2 at rural background locations.',
  'UKEAP: Acid Gas & Aerosol Network (AGANet)': 'Weekly integrated sampling of acidic gases and aerosol ionic components.',
  'UKEAP: MARGA Network': 'Automatic hourly aqueous-phase measurements of ions in gas and aerosol.',
  'PAH Network': 'Measurement of polycyclic aromatic hydrocarbons at selected sites.',
  'Heavy Metals Network': 'Particulate-bound metal concentrations measured at urban and industrial sites.',
  'UKEAP: National Ammonia Monitoring Network (NAMN)': 'National ammonia measurements using active and passive samplers.',
  'UKEAP: Precipitation Chemistry Network (Precip-Net)': 'Chemical composition of rainfall at rural sites.',
  'UKEAP: Rural Mercury Network': 'Speciated mercury measurements at rural background locations.',
  'Locally managed automatic monitoring': 'Automatic monitoring operated by local authorities or partners (non-Defra).',
  // Extra networks you listed (not all necessarily used by mapping, but supported):
  'Black Carbon Network': 'Black carbon (BC) and UVPM measurements.',
  'TOXics Organic Micro-Pollutants (TOMPs)': 'PCBs, pesticides and other semi-volatile organics.',
  'Particle Concentrations & Numbers (PCN)': 'Particle number, size distributions, OC/EC, elemental composition.'
};

/* -------------------- NEW: Network start years (defaults to 2000 if missing) -------------------- */
const NETWORK_START_YEARS = {
  'Automatic Urban and Rural Network (AURN)': 1972,
  'Automatic Hydrocarbon Network': 1992,
  'Locally-managed automatic monitoring': 1973,   // variant from your table
  'Locally managed automatic monitoring': 1973,   // variant used in code
  'UKEAP: Precipitation Chemistry Network (Precip-Net)': 1986, // table “UKEAP — Precip-Net”
  'UKEAP — Precip-Net': 1986,
  'UKEAP: Acid Gas & Aerosol Network (AGANet)': 2000,  // not stated → default
  'UKEAP: National Ammonia Monitoring Network (NAMN)': 2000, // not stated → default
  'UKEAP: Rural NO2 Network': 2000, // not stated → default
  'UKEAP: MARGA Network': 2000,     // not stated → default
  'UKEAP: Rural Mercury Network': 2000, // not stated → default
  'Black Carbon Network': 2006,
  'PAH Network': 1991,
  'TOXics Organic Micro-Pollutants (TOMPs)': 1991,
  'Non-Automatic Hydrocarbon Network': 2001,
  'Heavy Metals Network': 2000, // not stated → default
  'Particle Concentrations & Numbers (PCN)': 2001,
  'UK Urban NO2 Network': 2020,
};

function getNetworkStartYear(name) {
  // Try direct, then a couple of safe normalisations
  if (NETWORK_START_YEARS[name]) return NETWORK_START_YEARS[name];
  const normalized = name
    .replace(/\s*—\s*/g, ': ')   // em dash → colon (UKEAP — X → UKEAP: X)
    .replace(/\s+/g, ' ')
    .trim();
  return NETWORK_START_YEARS[normalized] || 2000;
}

const CURRENT_YEAR = new Date().getFullYear();

/* -------------------- Helpers: time parsing & availability -------------------- */
function getSingleYearFromTimeText(t) {
  if (!t) return null;
  const matches = t.match(/(\d{4})/g);
  if (!matches || !matches.length) return null;
  return parseInt(matches[matches.length - 1], 10);
}

/* -------------------- Per-network builders (respect network start years) -------------------- */
// MONTHLY
function buildMonthlyButtonsForNetwork(timeText, networkName) {
  const year = getSingleYearFromTimeText(timeText);
  const start = getNetworkStartYear(networkName);
  if (year && year < start) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected period (${year}). Data for this network starts in ${start}.</p>
    `;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${buttonHtml('Download metadata')}<br>
    ${buttonHtml('Download data')}
  `;
}
function buildMonthlyYearTableForNetwork(userStart, userEnd, networkName) {
  const start = Math.max(getNetworkStartYear(networkName), userStart);
  const end = Math.min(userEnd, CURRENT_YEAR);
  if (start > end) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected range. Data for this network starts in ${getNetworkStartYear(networkName)}.</p>
    `;
  }
  const hasMultipleYears = start !== end;
  const metadataButton = hasMultipleYears ? `${buttonHtml('Download metadata')}` : '';
  let rows = '';
  for (let y = end; y >= start; y--) {
    rows += `
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">${y}</th>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download data</a></td>
      </tr>`;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${metadataButton}
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row"><th scope="col" class="govuk-table__header">Year</th><th scope="col" class="govuk-table__header">Download</th></tr>
      </thead>
      <tbody class="govuk-table__body">${rows}</tbody>
    </table>
  `;
}

// HOURLY
function buildHourlyButtonsForNetwork(timeText, networkName) {
  const year = getSingleYearFromTimeText(timeText);
  const start = getNetworkStartYear(networkName);
  if (year && year < start) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected period (${year}). Data for this network starts in ${start}.</p>
    `;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${buttonHtml('Download metadata')}<br>
    ${buttonHtml('Download hourly data')}<br>
    ${buttonHtml('Download daily average data')}<br>
    ${buttonHtml('Download annual average data')}
  `;
}
function buildHourlyYearTableForNetwork(userStart, userEnd, networkName) {
  const start = Math.max(getNetworkStartYear(networkName), userStart);
  const end = Math.min(userEnd, CURRENT_YEAR);
  if (start > end) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected range. Data for this network starts in ${getNetworkStartYear(networkName)}.</p>
    `;
  }
  const hasMultipleYears = start !== end;
  const metadataButton = hasMultipleYears ? `${buttonHtml('Download metadata')}` : '';
  let rows = '';
  for (let y = end; y >= start; y--) {
    rows += `
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">${y}</th>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download hourly data</a></td>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download daily average data</a></td>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download annual average data</a></td>
      </tr>`;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${metadataButton}
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Year</th>
          <th scope="col" class="govuk-table__header">Hourly data</th>
          <th scope="col" class="govuk-table__header">Daily average</th>
          <th scope="col" class="govuk-table__header">Annual average</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">${rows}</tbody>
    </table>
  `;
}

// NON-DEFRA
function buildNonDefraButtonsForNetwork(timeText, networkName) {
  const year = getSingleYearFromTimeText(timeText);
  const start = getNetworkStartYear(networkName);
  if (year && year < start) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected period (${year}). Data for this network starts in ${start}.</p>
    `;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${buttonHtml('Download metadata')}<br>
    ${buttonHtml('Download hourly data')}<br>
    ${buttonHtml('Download daily average data')}<br>
    ${buttonHtml('Download annual average data')}
  `;
}
function buildNonDefraYearTableForNetwork(userStart, userEnd, networkName) {
  const start = Math.max(getNetworkStartYear(networkName), userStart);
  const end = Math.min(userEnd, CURRENT_YEAR);
  if (start > end) {
    return `
      <h3 class="govuk-heading-s">${networkName}</h3>
      <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
      <p class="govuk-body">No data available for the selected range. Data for this network starts in ${getNetworkStartYear(networkName)}.</p>
    `;
  }
  const hasMultipleYears = start !== end;
  const metadataButton = hasMultipleYears ? `${buttonHtml('Download metadata')}` : '';
  let rows = '';
  for (let y = end; y >= start; y--) {
    rows += `
      <tr class="govuk-table__row">
        <th scope="row" class="govuk-table__header">${y}</th>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download hourly data</a></td>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download daily average data</a></td>
        <td class="govuk-table__cell"><a href="#" class="govuk-link">Download annual average data</a></td>
      </tr>`;
  }
  return `
    <h3 class="govuk-heading-s">${networkName}</h3>
    <p class="govuk-body">${NETWORK_DESCRIPTIONS[networkName] || ''}</p>
    ${metadataButton}
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Year</th>
          <th scope="col" class="govuk-table__header">Hourly data</th>
          <th scope="col" class="govuk-table__header">Daily average</th>
          <th scope="col" class="govuk-table__header">Annual average</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">${rows}</tbody>
    </table>
  `;
}

/* -------------------- Data sources summary + tabs (respect selection) -------------------- */
document.addEventListener('DOMContentLoaded', function () {
  const HOUR_HDR   = '<strong>Latest hourly data from Defra</strong>';
  const MONTH_HDR  = '<strong>Weekly and monthly data from Defra</strong>';
  const NONDEF_HDR = '<strong>Non-Defra data</strong>';
  const pollutants = JSON.parse(sessionStorage.getItem('selectedPollutants_normalised') || '[]');
  let selected = null; try { selected = JSON.parse(sessionStorage.getItem('selectedDataSources') || 'null'); } catch {}

  function availabilityFromPollutants(pollutants) {
    const flat = [], seen = new Set();
    pollutants.forEach(p => { (buildNetworksForPollutant(p) || []).forEach(x => { if (!seen.has(x)) { flat.push(x); seen.add(x); } }); });
    const buckets = { hourly: [], monthly: [], nonDefra: [] };
    let current = null;
    flat.forEach(item => {
      if (item === HOUR_HDR) current = 'hourly';
      else if (item === MONTH_HDR) current = 'monthly';
      else if (item === NONDEF_HDR) current = 'nonDefra';
      else if (current) buckets[current].push(item);
    });
    return { flat, buckets };
  }

  function selectionRespectingAvailability(selected, available) {
    if (!selected) return null;
    const hourlyChosen  = (selected.hourly?.networks  || []).filter(n => available.buckets.hourly.includes(n));
    const monthlyChosen = (selected.monthly?.networks || []).filter(n => available.buckets.monthly.includes(n));
    const hasHourly  = !!selected.hourly?.enabled && hourlyChosen.length > 0;
    const hasMonthly = !!selected.monthly?.enabled && monthlyChosen.length > 0;
    const hasLocal   = !!selected.local && available.buckets.nonDefra.length > 0;
    if (!(hasHourly || hasMonthly || hasLocal)) return null;

    const flat = [];
    if (hasHourly)  flat.push(HOUR_HDR, ...hourlyChosen);
    if (hasMonthly) flat.push(MONTH_HDR, ...monthlyChosen);
    if (hasLocal)   flat.push(NONDEF_HDR, 'Locally managed automatic monitoring');

    return {
      flat,
      buckets: {
        hourly:   hasHourly  ? [...hourlyChosen]  : [],
        monthly:  hasMonthly ? [...monthlyChosen] : [],
        nonDefra: hasLocal   ? ['Locally managed automatic monitoring'] : []
      }
    };
  }

  const available = availabilityFromPollutants(pollutants);
  const filtered  = selectionRespectingAvailability(selected, available);
  const finalFlat    = filtered ? filtered.flat    : available.flat;
  const finalBuckets = filtered ? filtered.buckets : available.buckets;

  // Summary: Data source
  const dsTarget = document.getElementById('download-data-source');
  if (dsTarget) {
    dsTarget.innerHTML = (!pollutants.length) ? 'Any'
      : (finalFlat.length ? finalFlat.map(x => `<div>${x}</div>`).join('') : 'Any');
  }

  // Tabs
  const tabsContainer = document.querySelector('.govuk-tabs__list');
  const panelsRoot    = document.querySelector('.govuk-tabs');
  if (!tabsContainer || !panelsRoot) return;

  const sources = [];
  if (finalBuckets.hourly.length)   sources.push('Latest hourly data from Defra');
  if (finalBuckets.monthly.length)  sources.push('Weekly and monthly data from Defra');
  if (finalBuckets.nonDefra.length) sources.push('Non-Defra data');
  if (!sources.length) sources.push('Weekly and monthly data from Defra');

  tabsContainer.innerHTML = '';
  panelsRoot.querySelectorAll('.govuk-tabs__panel').forEach(el => el.remove());

  const slugify = t => t.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
  const timePeriod = sessionStorage.getItem('selectedTimePeriod') || '';

  function parseTimeMode() {
    const rangeMatch      = timePeriod && timePeriod.match(/(\d{4}).*to.*(\d{4})/);
    const lastYearMatch   = timePeriod && timePeriod.match(/1 January to 31 December (\d{4})/);
    const yearToDateMatch = timePeriod && timePeriod.match(/1 January to \d{1,2} \w+ (\d{4})/);
    if (rangeMatch) {
      let startYear = parseInt(rangeMatch[1], 10);
      let endYear   = parseInt(rangeMatch[2], 10);
      // clamp end to current year; leave start as-is (1970 etc. allowed)
      endYear = Math.min(endYear, CURRENT_YEAR);
      return (isNaN(startYear) || isNaN(endYear) || startYear > endYear) ? { mode:'invalid' } : { mode:'range', startYear, endYear };
    }
    if (lastYearMatch)   return { mode:'single', year: parseInt(lastYearMatch[1], 10) };
    if (yearToDateMatch) return { mode:'single', year: parseInt(yearToDateMatch[1], 10) };
    return { mode:'none' };
  }

  function buildMonthlyPanel(networks) {
    const tm = parseTimeMode();
    if (tm.mode === 'invalid') return `<p class="govuk-body">Invalid year range selected. <a href="add-time.html" class="govuk-link">Go back</a>.</p>`;
    if (tm.mode === 'none')    return `<p class="govuk-body">No valid time period selected. <a href="add-time.html" class="govuk-link">Choose one</a>.</p>`;
    if (tm.mode === 'range')   return networks.map(n => buildMonthlyYearTableForNetwork(tm.startYear, tm.endYear, n)).join('');
    return networks.map(n => buildMonthlyButtonsForNetwork(timePeriod, n)).join('');
  }
  function buildHourlyPanel(networks) {
    const tm = parseTimeMode();
    if (tm.mode === 'invalid') return `<p class="govuk-body">Invalid year range selected. <a href="add-time.html" class="govuk-link">Go back</a>.</p>`;
    if (tm.mode === 'none')    return `<p class="govuk-body">No valid time period selected. <a href="add-time.html" class="govuk-link">Choose one</a>.</p>`;
    if (tm.mode === 'range')   return networks.map(n => buildHourlyYearTableForNetwork(tm.startYear, tm.endYear, n)).join('');
    return networks.map(n => buildHourlyButtonsForNetwork(timePeriod, n)).join('');
  }
  function buildNonDefraPanel(networks) {
    const tm = parseTimeMode();
    if (tm.mode === 'invalid') return `<p class="govuk-body">Invalid year range selected. <a href="add-time.html" class="govuk-link">Go back</a>.</p>`;
    if (tm.mode === 'none')    return `<p class="govuk-body">No valid time period selected. <a href="add-time.html" class="govuk-link">Choose one</a>.</p>`;
    if (tm.mode === 'range')   return networks.map(n => buildNonDefraYearTableForNetwork(tm.startYear, tm.endYear, n)).join('');
    return networks.map(n => buildNonDefraButtonsForNetwork(timePeriod, n)).join('');
  }

  function buildPanelContent(source) {
    // Always keep the H2 under the tab
    let header = `<h2 class="govuk-heading-m">${source}</h2>`;
    if (source === 'Weekly and monthly data from Defra') {
      const networks = finalBuckets.monthly || [];
      return header + buildMonthlyPanel(networks);
    }
    if (source === 'Latest hourly data from Defra') {
      const networks = finalBuckets.hourly || [];
      return header + buildHourlyPanel(networks);
    }
    // Non-Defra
    const networks = finalBuckets.nonDefra || [];
    return header + buildNonDefraPanel(networks);
  }

  sources.forEach((source, i) => {
    const id = slugify(source);
    tabsContainer.insertAdjacentHTML('beforeend',
      `<li class="govuk-tabs__list-item${i===0?' govuk-tabs__list-item--selected':''}">
        <a class="govuk-tabs__tab" href="#${id}">${source}</a>
      </li>`);
    panelsRoot.insertAdjacentHTML('beforeend',
      `<div class="govuk-tabs__panel${i===0?'':' govuk-tabs__panel--hidden'}" id="${id}">
        ${buildPanelContent(source)}
      </div>`);
  });
});
</script>









{% endblock %}
